<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Player Manager â€” Add/Edit Stats</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f8fafc;--text:#1e293b;--card:#ffffff;--accent:#3b82f6;--muted:#475569;--success:#10b981;--success-light:#ecfdf5;--danger:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:all .25s;}
    header{background:#1e40af;color:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;}
    nav{display:flex;justify-content:center;gap:10px;padding:0.75rem;background:#e2e8f0;}
    nav a{color:#fff;text-decoration:none;padding:.6rem 1rem;background:var(--accent);border-radius:6px;font-weight:600;}
    .main-wrap{max-width:1100px;margin:1.25rem auto;padding:0 1rem;display:grid;gap:1.5rem;grid-template-columns:1fr 1.2fr;}
    .section{background:var(--card);padding:1.5rem;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.04);}
    .form-row{display:flex;gap:.5rem;margin-bottom:1rem;}
    .input{width:100%;padding:.6rem;border-radius:8px;border:1px solid #e2e8f0;font-size:0.95rem;}
    .players-list{margin:1rem 0 0;padding:0;list-style:none;max-height:400px;overflow-y:auto;border:1px solid #f1f5f9;border-radius:8px;}
    .players-list li{padding:.75rem;border-bottom:1px solid #f1f5f9;cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
    .players-list li:hover{background:#f8fafc;}
    .players-list li.selected{border-left:4px solid var(--accent);background:#eff6ff;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;}
    .week-options{display:flex;gap:5px;margin-bottom:1rem;}
    .week-options button{flex:1;padding:8px;border:1px solid var(--accent);background:none;color:var(--accent);border-radius:6px;cursor:pointer;font-weight:600;}
    .week-options button.selected{background:var(--accent);color:white;}
    .btn{padding:.6rem 1.2rem;border-radius:8px;border:0;color:#fff;font-weight:600;cursor:pointer;}
    .btn.save{background:var(--success)}
    .btn.delete{background:var(--danger)}
    .hidden { display: none !important; }
    #metricPreview{margin-top:1rem;padding:1rem;background:var(--success-light);border-radius:8px; font-size: 0.9rem;}
    .metric-row{display:flex;justify-content:space-between;margin-bottom:4px;}
    body.dark-mode{--bg:#0f172a;--text:#facc15;--card:#111827;}
  </style>
</head>
<body>
  <header><h1>Player Manager</h1><button class="btn" id="darkToggle" style="background:var(--accent)">Theme</button></header>
  <nav><a href="index.html">Dashboard</a><a href="form.html">Add/Edit Data</a><a href="config.html">Config</a></nav>

  <main class="main-wrap">
    <section class="section">
      <h2>1. Select Player</h2>
      <form id="playerForm" class="form-row">
        <input id="playerNameInput" placeholder="New player name..." class="input">
        <button type="submit" class="btn save">Add</button>
      </form>
      <input type="text" id="playerSearch" placeholder="Search existing players..." class="input">
      <ul class="players-list" id="playersList"></ul>
    </section>

    <section id="statsSection" class="section">
      <h2>2. Edit Stats: <span id="selectedPlayerDisplay" style="color:var(--accent)">None Selected</span></h2>
      <div id="weekOptions" class="week-options">
        <button type="button" data-week="week 1" class="week-btn selected">Week 1</button>
        <button type="button" data-week="week 2" class="week-btn">Week 2</button>
        <button type="button" data-week="week 3" class="week-btn">Week 3</button>
      </div>

      <div class="grid-2">
        <div><label>Power</label><input id="f_power" type="number" class="input"></div>
        <div><label>Points</label><input id="f_points" type="number" class="input"></div>
        <div><label>Throne</label><input id="f_throne" type="number" class="input"></div>
        <div><label>Frosts</label><input id="f_frost" type="number" class="input"></div>
        <div><label>Quest Score</label><input id="f_quest" type="number" class="input"></div>
        <div><label>Hero Pick (100)</label><div style="padding-top:8px"><input type="checkbox" id="pick_100" style="transform:scale(1.5)"></div></div>
      </div>

      <div id="metricPreview">
        <div class="metric-row"><strong>Current Total:</strong><span id="preview_total">0.00</span></div>
        <div class="metric-row"><span>Frost Contribution:</span><span id="preview_frost">0.00</span></div>
      </div>

      <div style="margin-top:1.5rem; display:flex; gap:10px;">
        <button class="btn save" id="statsSaveBtn" style="flex:2">Save Entry</button>
        <button class="btn delete" id="statsDeleteBtn" style="flex:1">Delete Player</button>
      </div>
    </section>
  </main>

  <script>
    (function () {
      const WEEKS = ['week 1','week 2','week 3'];
      let currentPlayer = null;
      let currentWeek = 'week 1';

      const E = {
        playersList: document.getElementById('playersList'),
        playerSearch: document.getElementById('playerSearch'),
        selectedPlayerDisplay: document.getElementById('selectedPlayerDisplay'),
        power: document.getElementById('f_power'),
        points: document.getElementById('f_points'),
        throne: document.getElementById('f_throne'),
        frost: document.getElementById('f_frost'),
        quest: document.getElementById('f_quest'),
        p100: document.getElementById('pick_100'),
        preview_total: document.getElementById('preview_total'),
        preview_frost: document.getElementById('preview_frost'),
        statsSaveBtn: document.getElementById('statsSaveBtn')
      };

      const loadData = () => JSON.parse(localStorage.getItem('formData') || '[]');
      const saveData = (d) => localStorage.setItem('formData', JSON.stringify(d));
      const loadMults = () => JSON.parse(localStorage.getItem('scoringMultipliers') || '{"M_WEEK1":0.1,"M_QUEST":0.0000025,"M_THRONE":3.0,"M_FROST":0.00001}');

      function computePreview() {
        if(!currentPlayer) return;
        const m = loadMults();
        const p = parseFloat(E.power.value) || 0;
        const pts = parseFloat(E.points.value) || 0;
        const f = parseFloat(E.frost.value) || 0;
        const q = parseFloat(E.quest.value) || 0;

        const rawEff = p > 0 ? pts / p : 0;
        const tScore = p > 0 ? (parseFloat(E.throne.value||0)/p) * m.M_THRONE : 0;
        const fScore = f * m.M_FROST;
        const qScore = q * m.M_QUEST;

        const total = rawEff + tScore + fScore + qScore;
        E.preview_total.textContent = total.toFixed(2);
        E.preview_frost.textContent = fScore.toFixed(2);
      }

      function renderPlayers() {
        const data = loadData();
        const names = [...new Set(data.map(d => d.name))].sort();
        E.playersList.innerHTML = names.map(n => `<li class="${n===currentPlayer?'selected':''}" onclick="selectPlayer('${n.replace(/'/g, "\\'")}')"><span>${n}</span></li>`).join('');
        filterPlayers();
      }

      function filterPlayers() {
        const val = E.playerSearch.value.toLowerCase();
        Array.from(E.playersList.children).forEach(li => {
          li.classList.toggle('hidden', !li.textContent.toLowerCase().includes(val));
        });
      }

      window.selectPlayer = function(name) {
        currentPlayer = name;
        E.selectedPlayerDisplay.textContent = name;
        const data = loadData();
        const entry = data.find(d => d.name === name && d.week === currentWeek) || {};
        
        E.power.value = entry.power || '';
        E.points.value = entry.points || '';
        E.throne.value = entry.throne || '';
        E.frost.value = entry.frost || '';
        E.quest.value = entry.quest || '';
        E.p100.checked = !!entry.p100;
        
        renderPlayers();
        computePreview();
      };

      E.statsSaveBtn.onclick = () => {
        if(!currentPlayer) return alert("Select a player first!");
        let data = loadData();
        const idx = data.findIndex(d => d.name === currentPlayer && d.week === currentWeek);
        const newEntry = {
          name: currentPlayer, week: currentWeek,
          power: E.power.value, points: E.points.value, 
          throne: E.throne.value, frost: E.frost.value,
          quest: E.quest.value, p100: E.p100.checked ? 1 : 0
        };
        if(idx >= 0) data[idx] = {...data[idx], ...newEntry};
        else data.push(newEntry);
        saveData(data);
        alert("Saved!");
      };

      document.getElementById('playerForm').onsubmit = (e) => {
        e.preventDefault();
        const name = document.getElementById('playerNameInput').value.trim();
        if(!name) return;
        let data = loadData();
        WEEKS.forEach(w => data.push({name, week: w}));
        saveData(data);
        document.getElementById('playerNameInput').value = '';
        renderPlayers();
        selectPlayer(name);
      };

      document.getElementById('weekOptions').onclick = (e) => {
        if(!e.target.dataset.week) return;
        document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('selected'));
        e.target.classList.add('selected');
        currentWeek = e.target.dataset.week;
        if(currentPlayer) selectPlayer(currentPlayer);
      };

      E.playerSearch.oninput = filterPlayers;
      document.querySelectorAll('input').forEach(i => i.oninput = computePreview);

      // INITIALIZE
      renderPlayers();
      
      // FIX FOR HOMEPAGE "EDIT" LINK
      const editName = localStorage.getItem('editTargetName');
      const editWeek = localStorage.getItem('editTargetWeek');
      if(editName) {
        if(editWeek) {
          currentWeek = editWeek;
          document.querySelectorAll('.week-btn').forEach(b => b.classList.toggle('selected', b.dataset.week === editWeek));
        }
        selectPlayer(editName);
        localStorage.removeItem('editTargetName');
        localStorage.removeItem('editTargetWeek');
      }
    })();
  </script>
</body>
</html>
