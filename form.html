<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Alliance Manager - Live Rank</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{ --bg:#f1f5f9; --text:#1e293b; --card:#ffffff; --accent:#3b82f6; --success:#10b981; --danger:#ef4444; --dark:#0f172a; --muted:#64748b; }
        *{box-sizing:border-box}
        body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);padding-bottom:50px;}
        header{background:#1e40af;color:#fff;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;}
        nav{display:flex;justify-content:center;gap:12px;padding:.8rem;background:#cbd5e1;border-bottom:2px solid #94a3b8;}
        nav a{color:#fff;text-decoration:none;padding:.6rem 1.2rem;background:var(--accent);border-radius:8px;font-weight:700;font-size:0.9rem;}
        .main-wrap{ width:100%; padding:1.5rem; display:grid; gap:15px; grid-template-columns:280px 1fr 340px; align-items:start; }
        .section{ background:var(--card); padding:1.5rem; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.05); }
        .input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 10px; font-family: inherit;}
        .btn { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; width:100%; transition: 0.2s; }
        .week-tabs { display: flex; gap: 5px; margin-bottom: 20px; background: #e2e8f0; padding: 5px; border-radius: 10px; }
        .week-btn { flex: 1; padding: 8px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 700; color: var(--muted); font-size: 0.7rem; }
        .week-btn.selected { background: white; color: var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .dot { height: 10px; width: 10px; background-color: #cbd5e1; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .dot.active { background-color: var(--success); box-shadow: 0 0 8px var(--success); }
        .toggle-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 6px; margin-bottom: 15px; }
        .tgl-btn input { display: none; }
        .tgl-btn label { display: block; padding: 8px 2px; background: #f1f5f9; border-radius: 6px; text-align: center; font-size: 0.6rem; font-weight: 800; cursor: pointer; color: var(--muted); border: 1px solid #e2e8f0; }
        .tgl-btn input:checked + label { background: var(--accent); color: white; border-color: var(--accent); }
        .players-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 10px; }
        .players-list li { padding: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; align-items: center; font-size: 0.85rem; }
        .players-list li.active { background: #eff6ff; color: var(--accent); font-weight: 700; border-left: 5px solid var(--accent); }

        /* ANALYSIS PANEL */
        .analysis-panel { background: var(--dark); color: white; border-radius: 20px; padding: 20px; position: sticky; top: 1.5rem; }
        .rank-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .rank-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .rank-card label { display: block; font-size: 0.55rem; color: #94a3b8; text-transform: uppercase; font-weight: 800; }
        .rank-card .val { font-size: 1rem; font-weight: 800; color: #60a5fa; }
        .rank-card .rnk { float: right; font-size: 0.7rem; color: #10b981; }
        .overall-rank { background: linear-gradient(135deg, #3b82f6, #1e40af); padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 15px; }
        .overall-rank label { font-size: 0.7rem; font-weight: 800; opacity: 0.8; }
        .overall-rank .big-rank { font-size: 2.2rem; font-weight: 900; display: block; }
    </style>
</head>
<body>

<header><h1>Alliance Management</h1><div id="rosterCount">0 Players</div></header>
<nav><a href="index.html">Dashboard</a><a href="trends.html">Trends</a><a href="form.html">Manage Data</a></nav>

<main class="main-wrap">
    <section class="section">
        <h3>Directory</h3>
        <input type="text" id="playerSearch" placeholder="ðŸ” Search..." class="input" oninput="renderList()">
        <ul class="players-list" id="playersList"></ul>
        <textarea id="bulkInput" placeholder="Bulk Add Names" class="input" style="margin-top:15px;" rows="3"></textarea>
        <button class="btn" style="background:var(--success)" onclick="addNewPlayer()">Add Players</button>

        <div style="margin-top:20px; display:grid; gap:8px;">
            <button class="btn" style="background:#f59e0b" onclick="exportCSV()">Export CSV</button>
            <input type="file" id="importCSV" accept=".csv" style="display:none" onchange="importCSV(event)">
            <button class="btn" style="background:#f59e0b" onclick="document.getElementById('importCSV').click()">Import CSV</button>
            <button class="btn" style="background:var(--danger)" onclick="clearAllPlayerData()">Clear All Data</button>
            <button class="btn" style="background:#991b1b" onclick="deleteAllPlayers()">Delete All Players</button>
        </div>
    </section>

    <section class="section">
        <h2 id="editHeader" style="color:var(--accent); margin-top:0;">Select Player</h2>
        <div class="week-tabs">
            <button onclick="setWeek('home week')" class="week-btn" id="btn-homeweek">HOME</button>
            <button onclick="setWeek('week 1')" class="week-btn" id="btn-week1">W1</button>
            <button onclick="setWeek('week 2')" class="week-btn" id="btn-week2">W2</button>
            <button onclick="setWeek('week 3')" class="week-btn" id="btn-week3">W3</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:15px;">
            <div><label>POWER</label><input id="power" type="number" class="input" oninput="updateLive()"></div>
            <div><label>POINTS</label><input id="points" type="number" class="input" oninput="updateLive()"></div>
            <div><label>THRONE</label><input id="throne" type="number" class="input" oninput="updateLive()"></div>
            <div><label>QUEST</label><input id="quest" type="number" class="input" oninput="updateLive()"></div>
            <div><label>HUNT</label><input id="hunt" type="number" class="input" oninput="updateLive()"></div>
        </div>

        <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div style="flex:1;">
                <label>LANE</label>
                <div style="display:flex; align-items:center;">
                    <button style="width:40px; height:40px; background:#e2e8f0; border:none; cursor:pointer; font-size:1.2rem;" onclick="changeVal('lane', -1)">-</button>
                    <input id="lane" type="number" class="input" oninput="updateLive()" style="text-align:center;">
                    <button style="width:40px; height:40px; background:#e2e8f0; border:none; cursor:pointer; font-size:1.2rem;" onclick="changeVal('lane', 1)">+</button>
                </div>
            </div>
            <div style="flex:1; font-size:0.85rem;">
                <label>EMBLEM</label>
                <div style="display:flex; align-items:center;">
                    <button style="width:30px; height:30px; background:#e2e8f0; border:none; cursor:pointer; font-size:1rem;" onclick="changeVal('emblem', -1)">-</button>
                    <input id="emblem" type="number" class="input" oninput="updateLive()" style="text-align:center; font-size:0.85rem;">
                    <button style="width:30px; height:30px; background:#e2e8f0; border:none; cursor:pointer; font-size:1rem;" onclick="changeVal('emblem', 1)">+</button>
                </div>
            </div>
            <div style="flex:1; font-size:0.85rem;">
                <label>CHEST</label>
                <div style="display:flex; align-items:center;">
                    <button style="width:30px; height:30px; background:#e2e8f0; border:none; cursor:pointer; font-size:1rem;" onclick="changeVal('chest', -1)">-</button>
                    <input id="chest" type="number" class="input" oninput="updateLive()" style="text-align:center; font-size:0.85rem;">
                    <button style="width:30px; height:30px; background:#e2e8f0; border:none; cursor:pointer; font-size:1rem;" onclick="changeVal('chest', 1)">+</button>
                </div>
            </div>
        </div>

        <label style="font-size:0.6rem; font-weight:800; color:var(--muted)">ACTIVITY</label>
        <div class="toggle-grid">
            <div class="tgl-btn"><input type="checkbox" id="lava"><label for="lava">LAVA</label></div>
            <div class="tgl-btn"><input type="checkbox" id="challenge"><label for="challenge">CHALL</label></div>
            <div class="tgl-btn"><input type="checkbox" id="donations"><label for="donations">DONO</label></div>
            <div class="tgl-btn"><input type="checkbox" id="esb"><label for="esb">ESB</label></div>
            <div class="tgl-btn"><input type="checkbox" id="dv"><label for="dv">DV</label></div>
            <div class="tgl-btn"><input type="checkbox" id="mon"><label for="mon">MON</label></div>
            <div class="tgl-btn"><input type="checkbox" id="wed"><label for="wed">WED</label></div>
        </div>

        <label style="font-size:0.6rem; font-weight:800; color:var(--muted)">HERO PICKS</label>
        <div class="toggle-grid">
            <div class="tgl-btn"><input type="checkbox" id="p100" onchange="renderList(); updateLive();"><label for="p100">100</label></div>
            <div class="tgl-btn"><input type="checkbox" id="p40"><label for="p40">40</label></div>
            <div class="tgl-btn"><input type="checkbox" id="p20"><label for="p20">20</label></div>
            <div class="tgl-btn"><input type="checkbox" id="p5"><label for="p5">5</label></div>
        </div>

        <label style="font-size:0.6rem; font-weight:800; color:var(--muted)">KING PACKS</label>
        <div style="display:grid; grid-template-columns: 3fr 1fr 1fr; gap:6px; margin-bottom:15px; font-size:0.75rem;">
            <div></div><div style="text-align:center; font-weight:700;">T1</div><div style="text-align:center; font-weight:700;">T2</div>
            <div>Legendary</div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="legendary_t1"><label for="legendary_t1"></label></div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="legendary_t2"><label for="legendary_t2"></label></div>
            <div>Epic (heroes)</div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="epic_heroes_t1"><label for="epic_heroes_t1"></label></div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="epic_heroes_t2"><label for="epic_heroes_t2"></label></div>
            <div>Excellent (units)</div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="excellent_units_t1"><label for="excellent_units_t1"></label></div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="excellent_units_t2"><label for="excellent_units_t2"></label></div>
            <div>Rare (dragon)</div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="rare_dragon_t1"><label for="rare_dragon_t1"></label></div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="rare_dragon_t2"><label for="rare_dragon_t2"></label></div>
            <div>Rare (heroes)</div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="rare_heroes_t1"><label for="rare_heroes_t1"></label></div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="rare_heroes_t2"><label for="rare_heroes_t2"></label></div>
            <div>Rare (units)</div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="rare_units_t1"><label for="rare_units_t1"></label></div>
            <div class="tgl-btn" style="margin:0;"><input type="checkbox" id="rare_units_t2"><label for="rare_units_t2"></label></div>
        </div>

        <button class="btn" style="background:var(--success)" onclick="saveEntry()">SAVE DATA</button>
    </section>

    <aside class="analysis-panel">
        <div class="overall-rank">
            <label>ESTIMATED OVERALL RANK</label>
            <span class="big-rank" id="rnk_total">#--</span>
        </div>
        
        <div class="rank-grid">
            <div class="rank-card"><label>Points</label><span class="rnk" id="r_pts">#--</span><span class="val" id="val_pts">0</span></div>
            <div class="rank-card"><label>Efficiency</label><span class="rnk" id="r_eff">#--</span><span class="val" id="val_eff">0.000000</span></div>
            <div class="rank-card"><label>Quest</label><span class="rnk" id="r_qst">#--</span><span class="val" id="val_qst">0</span></div>
            <div class="rank-card"><label>Throne</label><span class="rnk" id="r_thr">#--</span><span class="val" id="val_thr">0</span></div>
            <div class="rank-card"><label>Throne Eff</label><span class="rnk" id="r_tef">#--</span><span class="val" id="val_tef">0.000000</span></div>
        </div>
    </aside>
</main>

<script>
let curP = null, curW = 'week 1';
const fKeys = ['power','points','throne','quest','hunt','lane','emblem','chest'];
const tKeys = ['lava','challenge','donations','esb','dv','mon','wed','p100','p40','p20','p5',
               'legendary_t1','legendary_t2','epic_heroes_t1','epic_heroes_t2','excellent_units_t1','excellent_units_t2',
               'rare_dragon_t1','rare_dragon_t2','rare_heroes_t1','rare_heroes_t2','rare_units_t1','rare_units_t2'];

const loadDB = () => JSON.parse(localStorage.getItem('formData') || '[]');
const saveDB = d => localStorage.setItem('formData', JSON.stringify(d));

window.setWeek = (w) => {
    curW = w;
    document.querySelectorAll('.week-btn').forEach(b => b.classList.toggle('selected', b.id === 'btn-'+w.replace(' ','')));
    if(curP) selectPlayer(curP);
    renderList();
};

window.selectPlayer = (n) => {
    curP = n; document.getElementById('editHeader').innerText = n;
    const db = loadDB();
    const entry = db.find(x => x.name === n && x.week === curW) || {};
    fKeys.forEach(f => document.getElementById(f).value = entry[f] || "");
    tKeys.forEach(t => document.getElementById(t).checked = (entry[t] === 1));
    renderList(); updateLive();
};

window.changeVal = (id, delta) => {
    const inp = document.getElementById(id);
    let v = (parseFloat(inp.value) || 0) + delta;
    inp.value = v < 0 ? 0 : v;
    updateLive();
};

window.updateLive = () => {
    if(!curP) return;
    const db = loadDB();
    const p = parseFloat(document.getElementById('power').value)||1;
    const pts = parseFloat(document.getElementById('points').value)||0;
    const q = parseFloat(document.getElementById('quest').value)||0;
    const t = parseFloat(document.getElementById('throne').value)||0;
    
    const eff = pts / p;
    const tef = t / p;

    document.getElementById('val_pts').innerText = pts.toLocaleString();
    document.getElementById('val_eff').innerText = eff.toFixed(6);
    document.getElementById('val_qst').innerText = q.toLocaleString();
    document.getElementById('val_thr').innerText = t.toLocaleString();
    document.getElementById('val_tef').innerText = tef.toFixed(6);

    // LIVE RANKING LOGIC
    const weekData = db.filter(x => x.week === curW);
    const getRank = (val, keyOrCalc, desc=true) => {
        const calc = typeof keyOrCalc === 'string' ? (x) => parseFloat(x[keyOrCalc])||0 : keyOrCalc;
        const scores = weekData.map(calc);
        scores.push(val);
        scores.sort((a,b) => desc ? b-a : a-b);
        return "#" + (scores.indexOf(val) + 1);
    };

    document.getElementById('r_pts').innerText = getRank(pts, 'points');
    document.getElementById('r_qst').innerText = getRank(q, 'quest');
    document.getElementById('r_thr').innerText = getRank(t, 'throne');
    document.getElementById('r_eff').innerText = getRank(eff, x => (parseFloat(x.points)||0) / (parseFloat(x.power)||1));
    document.getElementById('r_tef').innerText = getRank(tef, x => (parseFloat(x.throne)||0) / (parseFloat(x.power)||1));
    document.getElementById('rnk_total').innerText = getRank(pts + t, x => parseFloat(x.points) + parseFloat(x.throne)||0); // Simple total estimate
};

window.saveEntry = () => {
    if(!curP) return;
    let db = loadDB();
    const newData = { name: curP, week: curW };
    fKeys.forEach(f => newData[f] = document.getElementById(f).value);
    tKeys.forEach(t => newData[t] = document.getElementById(t).checked ? 1 : 0);
    
    const idx = db.findIndex(x => x.name === curP && x.week === curW);
    if(idx >= 0) db[idx] = newData; else db.push(newData);
    saveDB(db); renderList(); alert("Saved!");
};

window.addNewPlayer = () => {
    const raw = document.getElementById('bulkInput').value;
    let db = loadDB();
    raw.split('\n').forEach(n => {
        n = n.trim(); if(!n) return;
        ['home week','week 1','week 2','week 3'].forEach(w => {
            if(!db.find(x => x.name === n && x.week === w)) db.push({name:n, week:w});
        });
    });
    saveDB(db); document.getElementById('bulkInput').value = ""; renderList();
};

window.renderList = () => {
    const db = loadDB();
    const names = [...new Set(db.map(x => x.name))].sort();
    const search = document.getElementById('playerSearch').value.toLowerCase();
    rosterCount.innerText = names.length + " Players";
    
    document.getElementById('playersList').innerHTML = names.filter(n => n.toLowerCase().includes(search)).map(n => {
        const has100 = db.some(x => x.name === n && x.p100 === 1);
        return `<li class="${n===curP?'active':''}" onclick="selectPlayer('${n}')"><span class="dot ${has100?'active':''}"></span>${n}</li>`;
    }).join('');
};

function exportCSV() {
    const db = loadDB();
    if (!db.length) return alert("No data to export");
    const headers = ['name','week',...fKeys,...tKeys];
    const rows = db.map(row => headers.map(h => 
        row[h] == null ? "" : `"${(row[h]+"").replace(/"/g,'""')}"`
    ).join(','));
    const csv = [headers.join(','), ...rows].join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `alliance_${new Date().toISOString().slice(0,10)}.csv`;
    a.click(); URL.revokeObjectURL(url);
}

function importCSV(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        const lines = ev.target.result.trim().split('\n');
        if (lines.length < 2) return alert("Invalid CSV");
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g,''));
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            let row = [], field = '', quoted = false;
            for (let char of lines[i] + ',') {
                if (char === '"' && !quoted) { quoted = true; continue; }
                if (char === '"' && quoted) { quoted = false; continue; }
                if (char === ',' && !quoted) {
                    row.push(field.trim().replace(/""/g,'"')); field = '';
                    continue;
                }
                field += char;
            }
            if (row.length !== headers.length) continue;
            const obj = {};
            headers.forEach((h,idx) => {
                let v = row[idx];
                if (fKeys.includes(h) || tKeys.includes(h)) v = v ? (v === '1' ? 1 : parseFloat(v)||0) : 0;
                obj[h] = v;
            });
            if (obj.name && obj.week) data.push(obj);
        }
        if (!data.length) return alert("No valid rows");
        let db = loadDB();
        const map = new Map(db.map(e => [`${e.name}|${e.week}`, e]));
        data.forEach(d => map.set(`${d.name}|${d.week}`, d));
        saveDB(Array.from(map.values()));
        renderList();
        alert(`Imported/updated ${data.length} entries`);
    };
    reader.readAsText(file);
}

function clearAllPlayerData() {
    if (!confirm("Reset ALL stats to zero for every player and week?")) return;
    let db = loadDB();
    db = db.map(e => {
        const r = {name:e.name, week:e.week};
        fKeys.forEach(k => r[k] = "");
        tKeys.forEach(k => r[k] = 0);
        return r;
    });
    saveDB(db);
    if (curP) selectPlayer(curP);
    renderList();
    alert("All stats cleared.");
}

function deleteAllPlayers() {
    if (!confirm("DELETE every player and all data permanently?")) return;
    saveDB([]);
    curP = null;
    setWeek('week 1');
    renderList();
    alert("All players deleted.");
}

const tName = localStorage.getItem('editTargetName');
if(tName) {
    localStorage.removeItem('editTargetName');
    setWeek(localStorage.getItem('editTargetWeek') || 'week 1');
    selectPlayer(tName);
} else { setWeek('week 1'); }
</script>
</body>
</html>