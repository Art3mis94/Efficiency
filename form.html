<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manage Alliance Data</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f8fafc;--text:#1e293b;--card:#ffffff;--accent:#3b82f6;--success:#10b981;--danger:#ef4444;--dark-panel:#1e293b;--muted:#64748b;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);transition:all .25s;}
    header{background:#1e40af;color:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;}
    nav{display:flex;justify-content:center;gap:10px;padding:0.75rem;background:#e2e8f0;}
    nav a{color:#fff;text-decoration:none;padding:.6rem 1rem;background:var(--accent);border-radius:6px;font-weight:600;}
    
    .main-wrap{max-width:1450px;margin:1.5rem auto;padding:0 1rem;display:grid;gap:1.5rem;grid-template-columns:300px 1fr 320px; align-items: start;}
    .section{background:var(--card);padding:1.5rem;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.04);}
    
    /* Locked Page Size / Scrollable List */
    .players-list{margin-top:10px;padding:0;list-style:none; height: 450px; overflow-y: auto; border:1px solid #e2e8f0; border-radius:8px; background:#fff;}
    .players-list li{padding:.75rem;border-bottom:1px solid #f1f5f9;cursor:pointer; transition: 0.2s;}
    .players-list li.selected{background:#eff6ff;border-left:4px solid var(--accent);font-weight:600;}
    .players-list li:hover{background:#f1f5f9;}
    
    .input{width:100%;padding:.6rem;border-radius:8px;border:1px solid #e2e8f0;font-size:0.95rem;outline:none;}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;}
    .checkbox-group{display:flex;gap:1rem;flex-wrap:wrap;padding:12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;margin-top:5px;}
    
    .results-sidebar{background:var(--dark-panel); color:white; padding:1.5rem; border-radius:12px; position: sticky; top: 1.5rem;}
    .res-item{margin-bottom:1rem; padding-bottom:0.5rem; border-bottom:1px solid #334155;}
    .res-item label{font-size:0.75rem; color:#94a3b8; display:block; text-transform:uppercase; letter-spacing: 0.5px;}
    .res-item span{font-size:1.25rem; font-weight:700; color:var(--accent);}
    
    .rank-badge{background:var(--accent); text-align:center; padding:1rem; border-radius:8px; margin-top:1rem;}
    .rank-val{font-size:2.5rem; font-weight:800; display:block;}

    .btn{padding:.7rem 1.5rem;border-radius:8px;border:0;color:#fff;font-weight:600;cursor:pointer;width:100%;margin-top:10px; text-align:center; transition: opacity 0.2s;}
    .btn:active{opacity: 0.8;}
    .btn.csv{background:#475569; font-size: 0.8rem; margin-top: 5px;}
    
    .week-btn{padding:10px; border:1px solid var(--accent); background:none; color:var(--accent); border-radius:8px; cursor:pointer; flex:1; font-weight: 700;}
    .week-btn.selected{background:var(--accent); color:white;}
    
    .global-reset-zone{margin-top:30px; padding:15px; border:2px solid #fee2e2; border-radius:12px; background:#fff5f5;}

    @media (max-width: 1200px) { .main-wrap { grid-template-columns: 1fr; } .results-sidebar { position: static; } }
  </style>
</head>
<body>
  <header><h1>Alliance Management</h1></header>
  <nav>
    <a href="index.html">Dashboard</a>
    <a href="trends.html">Trends</a>
    <a href="form.html">Manage Data</a>
    <a href="config.html">Config</a>
  </nav>

  <main class="main-wrap">
    <section class="section">
      <h3>Player Directory</h3>
      <input type="text" id="playerSearch" placeholder="ðŸ” Search players..." class="input" style="margin-bottom:10px;">
      <ul class="players-list" id="playersList"></ul>
      
      <div style="margin-top:15px; padding-top:10px;">
        <input id="playerNameInput" placeholder="Add new player name..." class="input" style="margin-bottom:5px;">
        <button id="addPlayerBtn" class="btn" style="background:var(--success)">Add Player</button>
      </div>

      <div style="margin-top:20px; border-top:1px dashed #cbd5e1; padding-top:15px;">
        <label style="font-size:0.75rem; font-weight:700; color:var(--muted); display:block; margin-bottom:5px;">BACKUP & RESTORE</label>
        <button class="btn csv" onclick="exportToCSV()">Export CSV Backup</button>
        <label class="btn csv" style="display:block; cursor:pointer;">
          Import CSV <input type="file" hidden onchange="importFromCSV(this)">
        </label>
      </div>
    </section>

    <section class="section">
      <h2 id="editHeader">Select a Player</h2>
      <div id="weekOptions" style="display:flex; gap:5px; margin-bottom:1.5rem;">
        <button data-week="home week" class="week-btn">Home</button>
        <button data-week="week 1" class="week-btn selected">Week 1</button>
        <button data-week="week 2" class="week-btn">Week 2</button>
        <button data-week="week 3" class="week-btn">Week 3</button>
      </div>

      <div class="grid-2" id="inputContainer">
        <div><label>Current Power</label><input id="f_power" type="number" class="input"></div>
        <div><label>Total Points</label><input id="f_points" type="number" class="input"></div>
        <div><label>Throne Kills</label><input id="f_throne" type="number" class="input"></div>
        <div><label>Quest Score</label><input id="f_quest" type="number" class="input"></div>
        <div><label>Ultimate Hunt</label><input id="f_hunt" type="number" class="input"></div>
        
        <div style="grid-column: span 2">
          <label>Activity Checklist</label>
          <div class="checkbox-group">
            <label><input type="checkbox" id="chk_lava"> Lava</label>
            <label><input type="checkbox" id="chk_challenge"> Challenge</label>
            <label><input type="checkbox" id="chk_donations"> Dono</label>
            <label><input type="checkbox" id="chk_dv"> DV</label>
            <label><input type="checkbox" id="chk_esb"> ESB</label>
            <label><input type="checkbox" id="esi_mon"> ESI Mon</label>
            <label><input type="checkbox" id="esi_thu"> ESI Thu</label>
          </div>
        </div>

        <div style="grid-column: span 2">
          <label>Hero Picks (Weighted)</label>
          <div class="checkbox-group" style="background:#fff7ed">
            <label><input type="checkbox" id="pick_100"> 100 Pick</label>
            <label><input type="checkbox" id="pick_40"> 40 Pick</label>
            <label><input type="checkbox" id="pick_20"> 20 Pick</label>
            <label><input type="checkbox" id="pick_5"> 5 Pick</label>
          </div>
        </div>
      </div>
      
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn" id="statsSaveBtn" style="background:var(--success); flex:2; font-size:1.1rem;">Save Data (Enter)</button>
        <button class="btn" id="playerDeleteBtn" style="background:var(--danger); flex:1;">Delete Item</button>
      </div>

      <div class="global-reset-zone">
        <label style="font-size:0.75rem; font-weight:800; color:#b91c1c; display:block; margin-bottom:10px; text-transform:uppercase;">Global Reset Options</label>
        <div style="display:flex; gap:10px;">
          <button class="btn" onclick="clearAllData()" style="background:#ef4444; margin-top:0; font-size:0.8rem;">Clear All Scores (Keep Names)</button>
          <button class="btn" onclick="deleteAllPlayers()" style="background:#000; margin-top:0; font-size:0.8rem;">Full Wipe (Delete Players)</button>
        </div>
      </div>
    </section>

    <aside class="results-sidebar">
      <h3>Live Analysis</h3>
      <div class="res-item"><label>Efficiency Score</label><span id="res_eff">0.0000</span></div>
      <div class="res-item"><label>Hunt Score</label><span id="res_hunt">0.00</span></div>
      <div class="res-item"><label>Throne Score</label><span id="res_throne">0.00</span></div>
      <div class="res-item"><label>Activity Pts</label><span id="res_act">0.00</span></div>
      
      <div class="rank-badge">
        <label style="color:white; opacity:0.8; font-size: 0.7rem;">ESTIMATED WEEKLY RANK</label>
        <span class="rank-val" id="res_rank">#--</span>
        <label style="color:white; margin-top:5px; display:block;">Total Score: <strong id="res_total">0.00</strong></label>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      const WEEKS = ['home week','week 1','week 2','week 3'];
      let currentPlayer = null, currentWeek = 'week 1';

      const loadData = () => JSON.parse(localStorage.getItem('formData') || '[]');
      const saveData = (d) => localStorage.setItem('formData', JSON.stringify(d));
      const loadMults = () => JSON.parse(localStorage.getItem('scoringMultipliers') || '{"M_WEEK1":0.1,"M_QUEST":0.0000025,"M_THRONE":3.0,"M_HUNT":0.00001}');

      // --- Global Actions ---
      window.clearAllData = () => {
        if(!confirm("Are you sure? This sets all scores to zero for everyone, but keeps the player names.")) return;
        const data = loadData().map(d => ({
          name: d.name, week: d.week,
          power:"", points:"", throne:"", quest:"", hunt:"",
          lava:0, challenge:0, donations:0, dv:0, esb:0, esi_mon:0, esi_thu:0,
          p100:0, p40:0, p20:0, p5:0
        }));
        saveData(data);
        if(currentPlayer) selectPlayer(currentPlayer);
        alert("All scores reset.");
      };

      window.deleteAllPlayers = () => {
        if(!confirm("WARNING: This will delete ALL players and ALL data. Are you sure?")) return;
        localStorage.removeItem('formData');
        currentPlayer = null; renderList(); resetSidebar();
        document.getElementById('editHeader').textContent = "Select a Player";
      };

      // --- Robust CSV Logic ---
      window.exportToCSV = () => {
        const data = loadData();
        if(!data.length) return alert("No data to export.");
        const headers = Object.keys(data[0]);
        const csvRows = [headers.join(",")];
        for (const row of data) {
          const values = headers.map(header => `"${row[header] === undefined ? "" : row[header]}"`);
          csvRows.push(values.join(","));
        }
        const blob = new Blob([csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `alliance_data_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
      };

      window.importFromCSV = (input) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
            const headers = lines[0].split(",").map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
            const data = lines.slice(1).map(line => {
              const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || line.split(",");
              const obj = {};
              headers.forEach((h, i) => {
                let val = values[i] ? values[i].trim().replace(/^"|"$/g, '') : "";
                obj[h] = val;
              });
              return obj;
            });
            if (!data[0].name) throw new Error();
            saveData(data); renderList(); location.reload();
          } catch (err) { alert("Invalid CSV. Ensure 'name' column exists."); }
        };
        reader.readAsText(input.files[0]);
      };

      // --- Calculations ---
      function calculateLiveMetrics() {
        if(!currentPlayer || currentWeek === 'home week') return resetSidebar();
        const m = loadMults();
        const getV = (id) => parseFloat(document.getElementById(id).value) || 0;
        const getC = (id) => document.getElementById(id).checked ? 1 : 0;

        const power = getV('f_power') || 1;
        const eff = getV('f_points') / power;
        const act = Math.min((getC('chk_lava') + getC('chk_challenge') + getC('chk_donations')) * 0.833, 2.5);
        const part = Math.min((getC('chk_dv')*0.833) + (getC('chk_esb')*0.833) + ((getC('esi_mon')+getC('esi_thu'))*0.416), 2.5);
        const throne = (getV('f_throne')/power) * m.M_THRONE;
        const hunt = getV('f_hunt') * (m.M_HUNT || 0);
        const quest = getV('f_quest') * m.M_QUEST;
        const total = eff + act + part + throne + hunt + quest;

        document.getElementById('res_eff').textContent = eff.toFixed(4);
        document.getElementById('res_hunt').textContent = hunt.toFixed(2);
        document.getElementById('res_throne').textContent = throne.toFixed(2);
        document.getElementById('res_act').textContent = (act + part).toFixed(2);
        document.getElementById('res_total').textContent = total.toFixed(2);

        const allThisWeek = loadData().filter(d => d.week === currentWeek && d.name !== currentPlayer);
        const better = allThisWeek.filter(d => {
            const p = parseFloat(d.power) || 1;
            const s = (parseFloat(d.points)/p) + 2.5 + ((parseFloat(d.hunt)||0)*m.M_HUNT);
            return s > total;
        }).length;
        document.getElementById('res_rank').textContent = `#${better + 1}`;
      }

      function resetSidebar() {
        ['res_eff','res_hunt','res_throne','res_act','res_total'].forEach(id => document.getElementById(id).textContent = '0.00');
        document.getElementById('res_rank').textContent = '#--';
      }

      window.selectPlayer = function(name){
        currentPlayer = name; 
        document.getElementById('editHeader').textContent = name;
        const entry = loadData().find(d => d.name === name && d.week === currentWeek) || {};
        ['power','points','throne','quest','hunt'].forEach(f => document.getElementById('f_'+f).value = entry[f] || '');
        ['lava','challenge','donations','dv','esb','esi_mon','esi_thu'].forEach(c => document.getElementById('chk_'+c).checked = (entry[c] == 1));
        ['100','40','20','5'].forEach(p => document.getElementById('pick_'+p).checked = (entry['p'+p] == 1));
        renderList(); calculateLiveMetrics();
      };

      function performSave(){
        if(!currentPlayer) return;
        let data = loadData();
        const idx = data.findIndex(d => d.name === currentPlayer && d.week === currentWeek);
        const state = {
          name: currentPlayer, week: currentWeek,
          power: document.getElementById('f_power').value, points: document.getElementById('f_points').value,
          throne: document.getElementById('f_throne').value, quest: document.getElementById('f_quest').value,
          hunt: document.getElementById('f_hunt').value,
          lava: document.getElementById('chk_lava').checked?1:0, challenge: document.getElementById('chk_challenge').checked?1:0,
          donations: document.getElementById('chk_donations').checked?1:0, dv: document.getElementById('chk_dv').checked?1:0,
          esb: document.getElementById('chk_esb').checked?1:0, esi_mon: document.getElementById('esi_mon').checked?1:0,
          esi_thu: document.getElementById('esi_thu').checked?1:0, p100: document.getElementById('pick_100').checked?1:0,
          p40: document.getElementById('pick_40').checked?1:0, p20: document.getElementById('pick_20').checked?1:0, p5: document.getElementById('pick_5').checked?1:0
        };
        if(idx >= 0) data[idx] = state; else data.push(state);
        saveData(data);
        const b = document.getElementById('statsSaveBtn'); b.textContent = "SAVED âœ“"; setTimeout(()=>b.textContent="Save Data (Enter)", 800);
      }

      function renderList(){
        const names = [...new Set(loadData().map(d => d.name))].sort();
        document.getElementById('playersList').innerHTML = names.map(n => `<li class="${n===currentPlayer?'selected':''}" onclick="selectPlayer('${n.replace(/'/g,"\\'")}')">${n}</li>`).join('');
      }

      document.getElementById('playerSearch').oninput = (e) => {
        const s = e.target.value.toLowerCase();
        Array.from(document.getElementById('playersList').children).forEach(li => li.style.display = li.textContent.toLowerCase().includes(s) ? '' : 'none');
      };

      document.getElementById('inputContainer').oninput = calculateLiveMetrics;
      document.getElementById('statsSaveBtn').onclick = performSave;
      document.addEventListener('keydown', (e) => { if(e.key === 'Enter' && currentPlayer) performSave(); });

      document.getElementById('weekOptions').onclick = (e) => {
        if(!e.target.dataset.week) return;
        document.querySelectorAll('.week-btn').forEach(b => b.classList.remove('selected'));
        e.target.classList.add('selected'); currentWeek = e.target.dataset.week;
        if(currentPlayer) selectPlayer(currentPlayer);
      };

      document.getElementById('addPlayerBtn').onclick = () => {
        const n = document.getElementById('playerNameInput').value.trim();
        if(!n) return;
        let d = loadData(); WEEKS.forEach(w => d.push({name: n, week: w}));
        saveData(d); renderList(); selectPlayer(n);
        document.getElementById('playerNameInput').value = "";
      };

      document.getElementById('playerDeleteBtn').onclick = () => {
        if(!currentPlayer || !confirm(`Delete ${currentPlayer}?`)) return;
        saveData(loadData().filter(d => d.name !== currentPlayer));
        currentPlayer = null; renderList(); resetSidebar();
      };

      renderList();
      const target = localStorage.getItem('editTargetName');
      if(target) { selectPlayer(target); localStorage.removeItem('editTargetName'); }
    })();
  </script>
</body>
</html>
