<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manage Alliance Data</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f8fafc;--text:#1e293b;--accent:#3b82f6;--white:#ffffff;--muted:#64748b;--dark:#1e40af;}
    body{margin:0;font-family:Inter,sans-serif;background:var(--bg);display:flex;height:100vh;}
    .sidebar{width:280px;background:white;border-right:1px solid #e2e8f0;display:flex;flex-direction:column;}
    .sidebar-header{padding:20px;border-bottom:1px solid #f1f5f9;}
    .player-list{flex:1;overflow-y:auto;list-style:none;padding:0;margin:0;}
    .player-list li{padding:12px 20px;cursor:pointer;border-bottom:1px solid #f8fafc;font-weight:600;}
    .player-list li:hover{background:#f1f5f9;}
    .player-list li.active{background:var(--accent);color:white;}
    .main-content{flex:1;overflow-y:auto;padding:40px;background:var(--bg);}
    .form-card{background:white;padding:30px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.05);max-width:800px;margin:auto;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
    label{display:block;font-size:0.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:6px;}
    input[type=number], input[type=text], select{width:100%;padding:10px;border-radius:8px;border:1px solid #cbd5e1;box-sizing:border-box;}
    .checkbox-group{display:grid;grid-template-columns:1fr 1fr;gap:10px;background:#f8fafc;padding:15px;border-radius:8px;}
    .check-item{display:flex;align-items:center;gap:10px;font-size:0.85rem;}
    .btn-save{width:100%;padding:14px;background:var(--accent);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:1rem;}
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="sidebar-header">
      <a href="index.html" style="text-decoration:none; color:var(--accent); font-weight:800;">‚Üê Back to Dashboard</a>
      <h3 style="margin:20px 0 10px 0;">Players</h3>
      <div style="display:flex; gap:5px;">
        <input type="text" id="newPlayerName" placeholder="Name..." style="flex:1;">
        <button onclick="addPlayer()" style="background:var(--accent); color:white; border:none; border-radius:4px; padding:0 10px; cursor:pointer;">+</button>
      </div>
    </div>
    <ul class="player-list" id="playersList"></ul>
  </div>

  <div class="main-content">
    <div class="form-card">
      <h2 id="formTitle">Select a player</h2>
      <form id="dataForm">
        <div class="grid">
          <div>
            <label>Select Week</label>
            <select id="weekSelector" onchange="loadPlayerWeekData()">
              <option value="week 1">Week 1</option>
              <option value="week 2">Week 2</option>
              <option value="week 3">Week 3</option>
            </select>
          </div>
          <div><label>Power</label><input type="number" name="power" id="power"></div>
          <div><label>Points</label><input type="number" name="points" id="points"></div>
          <div><label>Quests</label><input type="number" name="quest" id="quest"></div>
          <div><label>Hunt</label><input type="number" name="hunt" id="hunt"></div>
          <div><label>Throne Score</label><input type="number" name="throne" id="throne"></div>
        </div>

        <div class="grid">
          <div>
            <label>Activity</label>
            <div class="checkbox-group">
              <div class="check-item"><input type="checkbox" name="lava" id="lava"> Lava</div>
              <div class="check-item"><input type="checkbox" name="challenge" id="challenge"> Challenge</div>
              <div class="check-item"><input type="checkbox" name="donations" id="donations"> Donations</div>
            </div>
          </div>
          <div>
            <label>Participation</label>
            <div class="checkbox-group">
              <div class="check-item"><input type="checkbox" name="dv" id="dv"> DV</div>
              <div class="check-item"><input type="checkbox" name="esb" id="esb"> ESB</div>
              <div class="check-item"><input type="checkbox" name="esi_mon" id="esi_mon"> ESI Tue</div>
              <div class="check-item"><input type="checkbox" name="esi_thu" id="esi_thu"> ESI Thu</div>
            </div>
          </div>
        </div>

        <label>Hero Picks</label>
        <div class="checkbox-group" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 20px;">
          <div class="check-item"><input type="checkbox" name="p100" id="p100"> 100</div>
          <div class="check-item"><input type="checkbox" name="p40" id="p40"> 40</div>
          <div class="check-item"><input type="checkbox" name="p20" id="p20"> 20</div>
          <div class="check-item"><input type="checkbox" name="p5" id="p5"> 5</div>
        </div>

        <button type="submit" class="btn-save">Save Entry</button>
      </form>
    </div>
  </div>

  <script>
    (function() {
      const form = document.getElementById('dataForm');
      const playerList = document.getElementById('playersList');
      let players = JSON.parse(localStorage.getItem('players') || '[]');
      let formData = JSON.parse(localStorage.getItem('formData') || '[]');
      let selectedPlayer = null;

      function renderPlayerList() {
        playerList.innerHTML = '';
        players.sort((a,b)=>a.localeCompare(b)).forEach(name => {
          const li = document.createElement('li');
          li.textContent = name;
          li.onclick = () => selectPlayer(name, li);
          playerList.appendChild(li);
        });
      }

      function selectPlayer(name, element) {
        selectedPlayer = name;
        document.querySelectorAll('#playersList li').forEach(li => li.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('formTitle').textContent = "Editing: " + name;
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        loadPlayerWeekData();
      }

      function handleAutoEdit() {
        const target = localStorage.getItem('editTargetName');
        if (!target) return;

        // Force render first
        renderPlayerList();
        
        const items = Array.from(playerList.querySelectorAll('li'));
        const foundLi = items.find(li => li.textContent.trim() === target);

        if (foundLi) {
          selectPlayer(target, foundLi);
          localStorage.removeItem('editTargetName');
        }
      }

      window.addEventListener('load', () => {
        renderPlayerList();
        // Delay slightly to ensure DOM is settled for scroll
        setTimeout(handleAutoEdit, 50);
      });

      window.loadPlayerWeekData = function() {
        if (!selectedPlayer) return;
        const week = document.getElementById('weekSelector').value;
        form.reset();
        
        // Reset all checks
        const chks = ['lava','challenge','donations','dv','esb','esi_mon','esi_thu','p100','p40','p20','p5'];
        chks.forEach(id => { if(document.getElementById(id)) document.getElementById(id).checked = false; });

        const entry = formData.find(d => d.name === selectedPlayer && d.week === week);
        if (entry) {
          Object.keys(entry).forEach(key => {
            const el = document.getElementById(key);
            if (el) {
              if (el.type === 'checkbox') el.checked = entry[key];
              else el.value = entry[key];
            }
          });
        }
      };

      form.onsubmit = (e) => {
        e.preventDefault();
        if (!selectedPlayer) return alert('Select a player');
        const week = document.getElementById('weekSelector').value;
        const data = { name: selectedPlayer, week: week };
        
        const fd = new FormData(form);
        fd.forEach((value, key) => { data[key] = value; });
        
        ['lava','challenge','donations','dv','esb','esi_mon','esi_thu','p100','p40','p20','p5'].forEach(id => {
          data[id] = document.getElementById(id).checked;
        });

        const idx = formData.findIndex(d => d.name === selectedPlayer && d.week === week);
        if (idx > -1) formData[idx] = data;
        else formData.push(data);

        localStorage.setItem('formData', JSON.stringify(formData));
        alert('Data saved for ' + selectedPlayer);
      };

      window.addPlayer = () => {
        const name = document.getElementById('newPlayerName').value.trim();
        if (name && !players.includes(name)) {
          players.push(name);
          localStorage.setItem('players', JSON.stringify(players));
          renderPlayerList();
          document.getElementById('newPlayerName').value = '';
        }
      };
    })();
  </script>
</body>
</html>
