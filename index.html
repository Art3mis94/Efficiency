<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Player Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{--bg:#f8fafc;--text:#1e293b;--card:#ffffff;--accent:#3b82f6;--muted:#475569;}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--text);}
header{background:#1e40af;color:#fff;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;}
nav{display:flex;justify-content:center;gap:10px;padding:.75rem;background:#e2e8f0;flex-wrap:wrap;}
nav a{background:var(--accent);color:#fff;padding:.6rem 1rem;border-radius:6px;font-weight:600;text-decoration:none;}
main{max-width:1200px;margin:1.5rem auto;padding:0 1rem;display:grid;grid-template-columns:1fr 300px;gap:1.5rem;}
.dashboard-section,.top-performers{background:var(--card);padding:1.5rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);}
@media(max-width:992px){main{grid-template-columns:1fr}}

table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{padding:.75rem;border-bottom:1px solid #e2e8f0}
th{background:#f1f5f9}
th.sortable{cursor:pointer}
th.active-sort{background:#dbeafe;color:#1e40af}

.highlight-picks{
  background:#dcfce7;
  color:#166534;
  font-weight:700;
  padding:2px 6px;
  border-radius:4px;
}
body.dark-mode{
  --bg:#0f172a;--text:#facc15;--card:#111827;--accent:#fbbf24;
}
body.dark-mode header,body.dark-mode nav{background:#111827}
</style>
</head>

<body>
<header>
  <h1>Player Dashboard</h1>
  <button id="darkToggle">Dark Mode</button>
</header>

<nav>
  <a href="index.html">Dashboard</a>
  <a href="trends.html">Trends</a>
  <a href="emblems.html">Emblems</a>
  <a href="form.html">Add Data</a>
  <a href="config.html">Config</a>
</nav>

<main>
  <div class="dashboard-section">
    <h2>Weekly Data</h2>

    <select id="weekSelect"></select>
    <input id="searchInput" placeholder="Search name...">

    <table>
      <thead><tr id="tableHeaderRow"></tr></thead>
      <tbody id="dataTableBody"></tbody>
    </table>
  </div>

  <div class="top-performers">
    <h3>Top 3 Overall</h3>
    <ol id="top3List"></ol>
  </div>
</main>

<script>
/* ------------------ CORE STORAGE ------------------ */
const WEEKS = ['week 1','week 2','week 3'];
const loadData = () => JSON.parse(localStorage.getItem('formData')||'[]');
const saveData = d => localStorage.setItem('formData',JSON.stringify(d));

/* ------------------ PICKS FIX ------------------ */
function computePicks(e){
  return (e.p100?100:0)+(e.p40?40:0)+(e.p20?20:0)+(e.p5?5:0);
}

/* ------------------ METRICS ------------------ */
function calculateMetrics(e){
  const power = Number(e.power)||0;
  const points = Number(e.points)||0;
  const rawEff = power ? points/power : 0;
  const throneEff = power ? (Number(e.throne||0)/power)*3 : 0;

  const act = Math.min(((e.lava||0)+(e.challenge||0)+(e.donations||0))*(2.5/3),2.5);
  const part = Math.min(((e.dv||0)*(2.5/3))+((e.esb||0)*(2.5/3))+(((e.esi_mon||0)+(e.esi_thu||0))*(2.5/6)),2.5);

  return {
    ...e,
    rawEff,
    throneEfficiency:throneEff,
    activityPct:act,
    partPct:part,
    total:rawEff+throneEff+act+part,
    picks:computePicks(e)
  };
}

function calculateOverallMetrics(entries){
  const metrics = entries.map(calculateMetrics);
  return {
    name:entries[0].name,
    total:metrics.reduce((s,m)=>s+m.total,0),
    picks:metrics.reduce((s,m)=>s+m.picks,0)
  };
}

/* ------------------ DISPLAY ------------------ */
let currentSort='total';

function updateDisplay(){
  const view=weekSelect.value;
  const search=searchInput.value.toLowerCase();
  const data=loadData();

  tableHeaderRow.innerHTML='';
  dataTableBody.innerHTML='';

  if(view==='__total'){
    tableHeaderRow.innerHTML=`
      <th>Name</th>
      <th class="sortable">Total</th>
      <th>Picks</th>
    `;

    const grouped={};
    data.forEach(d=>{grouped[d.name]=grouped[d.name]||[];grouped[d.name].push(d);});

    Object.values(grouped)
      .map(calculateOverallMetrics)
      .filter(p=>p.name.toLowerCase().includes(search))
      .sort((a,b)=>b.total-a.total)
      .forEach(p=>{
        const picks=p.picks>=100?`<span class="highlight-picks">${p.picks}</span>`:p.picks;
        dataTableBody.innerHTML+=`<tr><td>${p.name}</td><td>${p.total.toFixed(2)}</td><td>${picks}</td></tr>`;
      });

  } else {
    tableHeaderRow.innerHTML=`
      <th>Name</th><th>Week</th><th>Total</th><th>Picks</th>
    `;
    data.filter(d=>d.week===view)
      .map(calculateMetrics)
      .filter(d=>d.name.toLowerCase().includes(search))
      .forEach(d=>{
        const picks=d.picks>=100?`<span class="highlight-picks">${d.picks}</span>`:d.picks;
        dataTableBody.innerHTML+=`
          <tr><td>${d.name}</td><td>${d.week}</td><td>${d.total.toFixed(2)}</td><td>${picks}</td></tr>
        `;
      });
  }
}

function updateTop3(){
  const grouped={};
  loadData().forEach(d=>{grouped[d.name]=grouped[d.name]||[];grouped[d.name].push(d);});
  const top=Object.values(grouped).map(calculateOverallMetrics).sort((a,b)=>b.total-a.total).slice(0,3);
  top3List.innerHTML=top.map((p,i)=>`<li>${i+1}. ${p.name} â€” ${p.total.toFixed(2)}</li>`).join('');
}

/* ------------------ INIT ------------------ */
weekSelect.innerHTML=['__total',...WEEKS].map(w=>`<option value="${w}">${w==='__total'?'Overall':w}</option>`).join('');
weekSelect.onchange=()=>{updateDisplay();updateTop3();}
searchInput.oninput=updateDisplay;

darkToggle.onclick=()=>{
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('theme',document.body.classList.contains('dark-mode')?'dark':'light');
};
if(localStorage.getItem('theme')==='dark')document.body.classList.add('dark-mode');

updateDisplay();updateTop3();
</script>
</body>
</html>