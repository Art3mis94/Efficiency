<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Alliance Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#f8fafc;--text:#1e293b;--accent:#3b82f6;--success:#10b981;--dark:#1e40af;--muted:#64748b;--gold:#f59e0b;}
    body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);font-size:0.85rem;}
    header{background:var(--dark);color:#fff;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;}
    nav{display:flex;justify-content:center;gap:10px;padding:0.75rem;background:#e2e8f0;}
    nav a{color:#fff;text-decoration:none;padding:.5rem 1rem;background:var(--accent);border-radius:6px;font-weight:700;}
    
    .container{padding:1.5rem;}
    .top-row{display:grid; grid-template-columns: 1fr 2.5fr; gap:20px; margin-bottom:20px;}
    .card{background:white; padding:15px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.05); border-left:4px solid var(--accent);}
    .card label{display:block; font-size:0.7rem; color:var(--muted); text-transform:uppercase; font-weight:800; margin-bottom:5px;}
    .card span{font-size:1.4rem; font-weight:800;}
    
    .leader-pill{background:#f1f5f9; padding:5px 12px; border-radius:20px; font-weight:700; font-size:0.8rem; border:1px solid #e2e8f0;}
    .leader-pill b{color:var(--gold);}

    details{background:white; border-radius:12px; margin-bottom:20px; border:1px solid #e2e8f0;}
    summary{padding:12px; cursor:pointer; font-weight:800; color:var(--muted); font-size:0.75rem;}
    .config-grid{display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; padding:15px;}
    .config-grid input{width:100%; padding:8px; border-radius:6px; border:1px solid #cbd5e1;}

    .table-wrap{background:white; border-radius:12px; overflow-x:auto; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);}
    table{width:100%; border-collapse:collapse; min-width:1100px;}
    th{background:#f8fafc; padding:12px; text-align:left; font-size:0.65rem; text-transform:uppercase; color:var(--muted); border-bottom:2px solid #e2e8f0;}
    td{padding:12px; border-bottom:1px solid #f1f5f9; cursor:pointer;}
    .status-green{color:var(--success) !important; font-weight:800;}
    
    .modal{display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); align-items:center; justify-content:center;}
    .modal-content{background:white; padding:25px; width:95%; max-width:1000px; border-radius:16px; position:relative; max-height:90vh; overflow-y:auto;}
    .ov-table{width:100%; border-collapse:collapse; margin-top:20px; font-size:0.8rem;}
    .ov-table th, .ov-table td{border:1px solid #e2e8f0; padding:8px; text-align:center;}
  </style>
</head>
<body>
  <header><h1>Alliance Dashboard</h1></header>
  <nav><a href="index.html">Dashboard</a><a href="form.html">Manage Data</a></nav>

  <div class="container">
    <div class="top-row">
      <div class="card"><label>Roster Count</label><span id="stat_total">0</span></div>
      <div class="card">
        <label>üèÜ Seasonal Leaders</label>
        <div id="topThreeList" style="display:flex; gap:10px; margin-top:5px;"></div>
      </div>
    </div>

    <details>
      <summary>‚öôÔ∏è SCORING CONFIGURATION</summary>
      <div class="config-grid">
        <div><label>M_THRONE</label><input type="number" step="0.1" id="m_throne" onchange="saveMults()"></div>
        <div><label>M_QUEST</label><input type="number" step="0.0000001" id="m_quest" onchange="saveMults()"></div>
        <div><label>M_W1_BASE</label><input type="number" step="0.1" id="m_w1" onchange="saveMults()"></div>
        <div><label>M_HUNT</label><input type="number" step="0.0000001" id="m_hunt" onchange="saveMults()"></div>
      </div>
    </details>

    <div style="display:flex; gap:15px; margin-bottom:15px;">
      <select id="weekSelect" style="font-weight:700; padding:10px; border-radius:8px; border:2px solid var(--accent);" onchange="render()">
        <option value="overall">OVERALL</option>
        <option value="week 1">WEEK 1</option><option value="week 2">WEEK 2</option><option value="week 3">WEEK 3</option>
      </select>
      <input type="text" id="dashSearch" placeholder="Search members..." style="flex:1; padding:10px; border-radius:8px; border:1px solid #cbd5e1;" oninput="render()">
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>Rank</th><th>Name</th><th>Power</th><th>Points</th><th>Eff</th><th>Act</th><th>Part</th><th>Throne</th><th>Total</th><th>Picks</th></tr>
        </thead>
        <tbody id="dashTableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span style="position:absolute; right:20px; top:15px; cursor:pointer; font-size:28px; font-weight:800;" onclick="closeModal()">&times;</span>
      <h2 id="modalName" style="margin-top:0;">Member Profile</h2>
      <div style="display:grid; grid-template-columns: 1.2fr 1.8fr; gap:20px;">
        <div>
          <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button onclick="updateGraph('power')">Power</button>
            <button onclick="updateGraph('points')">Points</button>
            <button onclick="updateGraph('eff')">Eff</button>
          </div>
          <div style="height:280px;"><canvas id="playerChart"></canvas></div>
        </div>
        <div style="overflow-x:auto;">
          <table class="ov-table">
            <thead><tr><th>Week</th><th>Power</th><th>Points</th><th>Eff</th><th>Throne</th><th>Quest</th><th>Hunt</th></tr></thead>
            <tbody id="ovTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      let chartInstance = null;
      let activeEntries = [];

      const load = () => JSON.parse(localStorage.getItem('formData') || '[]');
      const getMults = () => JSON.parse(localStorage.getItem('scoringMultipliers') || '{"M_THRONE":3.0,"M_QUEST":0.0000025,"M_W1":0.1,"M_HUNT":0.00001}');
      
      // Formatting for Power: 8,121,100 -> 8,121.1Bn
      const fmtPower = (n) => {
        if(!n) return "0.0Bn";
        const val = parseFloat(n) / 1000;
        return val.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "Bn";
      };

      const fmtNum = (n) => parseFloat(n || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});

      window.saveMults = () => {
        const m = {
          M_THRONE: parseFloat(document.getElementById('m_throne').value),
          M_QUEST: parseFloat(document.getElementById('m_quest').value),
          M_W1: parseFloat(document.getElementById('m_w1').value),
          M_HUNT: parseFloat(document.getElementById('m_hunt').value)
        };
        localStorage.setItem('scoringMultipliers', JSON.stringify(m));
        render();
      };

      window.render = () => {
        const data = load();
        const m = getMults();
        ['m_throne','m_quest','m_w1','m_hunt'].forEach(id => {
            const key = id === 'm_w1' ? 'M_W1' : id.toUpperCase();
            document.getElementById(id).value = m[key];
        });

        const view = document.getElementById('weekSelect').value;
        const search = document.getElementById('dashSearch').value.toLowerCase();
        const names = [...new Set(data.map(d => d.name))];
        let results = [];

        names.forEach(name => {
          const eAll = data.filter(d => d.name === name);
          const w1 = eAll.find(d => d.week === 'week 1') || {};
          const cur = view === 'overall' ? (eAll.find(d => d.week === 'week 3') || {}) : (eAll.find(d => d.week === view) || {});

          const p = parseFloat(cur.power) || 1;
          const pts = parseFloat(cur.points) || 0;
          
          const rawEff = (view === 'overall') ? ((pts - (parseFloat(w1.points)||0))/p) : (pts/p);
          const eff = (view === 'overall') ? rawEff + (m.M_W1 * (parseFloat(w1.points)||0)/p) : rawEff;
          
          const partRaw = ((cur.esb?1:0)*(1/3)) + ((cur.dv?1:0)*(1/3)) + ((cur.mon?1:0)*(1/6)) + ((cur.wed?1:0)*(1/6)); 
          const partScore = Math.min(2.5, partRaw + (parseFloat(cur.quest||0)*m.M_QUEST) + (parseFloat(cur.hunt||0)*m.M_HUNT));
          const actScore = ((cur.lava?1:0) + (cur.challenge?1:0) + (cur.donations?1:0)) * 0.833;
          const tEff = ((parseFloat(cur.throne)||0)/p) * m.M_THRONE;
          
          const total = eff + actScore + partScore + tEff;
          const picks = (view === 'overall') 
            ? eAll.reduce((s, e) => s + (e.p100?100:0) + (e.p40?40:0) + (e.p20?20:0) + (e.p5?5:0), 0)
            : (cur.p100?100:0) + (cur.p40?40:0) + (cur.p20?20:0) + (cur.p5?5:0);

          results.push({name, p, pts, eff, actScore, partScore, tEff, total, picks, has100: eAll.some(x=>x.p100==1)});
        });

        results.sort((a,b) => b.total - a.total);
        document.getElementById('stat_total').textContent = names.length;
        document.getElementById('topThreeList').innerHTML = results.slice(0,3).map((r,i) => 
          `<div class="leader-pill"><b>#${i+1}</b> ${r.name}</div>`).join('');

        document.getElementById('dashTableBody').innerHTML = results.filter(r => r.name.toLowerCase().includes(search)).map((r, i) => {
          const isG = r.has100 ? 'status-green' : '';
          return `<tr onclick="openOverlay('${r.name.replace(/'/g,"\\'")}')">
            <td>#${i+1}</td><td class="${isG}"><strong>${r.name}</strong></td>
            <td>${fmtPower(r.p)}</td><td>${fmtNum(r.pts)}</td>
            <td>${r.eff.toFixed(4)}</td><td>${r.actScore.toFixed(2)}</td>
            <td>${r.partScore.toFixed(2)}</td><td>${r.tEff.toFixed(2)}</td>
            <td style="font-weight:800;">${r.total.toFixed(2)}</td><td class="${isG}">${r.picks}</td>
          </tr>`;
        }).join('');
      };

      window.openOverlay = (name) => {
        const data = load();
        activeEntries = ['week 1','week 2','week 3'].map(w => data.find(d => d.name === name && d.week === w) || {week:w});
        document.getElementById('modalName').textContent = name;
        document.getElementById('ovTableBody').innerHTML = activeEntries.map(e => {
            const p = parseFloat(e.power)||1;
            return `<tr>
              <td>${e.week.toUpperCase()}</td>
              <td>${fmtPower(e.power)}</td>
              <td>${fmtNum(e.points)}</td>
              <td>${((parseFloat(e.points)||0)/p).toFixed(4)}</td>
              <td>${fmtNum(e.throne)}</td>
              <td>${fmtNum(e.quest)}</td>
              <td>${fmtNum(e.hunt)}</td>
            </tr>`;
        }).join('');
        document.getElementById('profileModal').style.display = 'flex';
        updateGraph('power');
      };

      window.updateGraph = (type) => {
        const ctx = document.getElementById('playerChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        const vals = activeEntries.map(e => {
          if(type === 'power') return parseFloat(e.power) || 0;
          if(type === 'points') return parseFloat(e.points) || 0;
          return (parseFloat(e.points)||0) / (parseFloat(e.power)||1);
        });
        chartInstance = new Chart(ctx, { type: 'line', data: { labels: ['W1', 'W2', 'W3'], datasets: [{ label: type.toUpperCase(), data: vals, borderColor: '#3b82f6', tension: 0.2 }] }, options: { maintainAspectRatio: false } });
      };

      window.closeModal = () => document.getElementById('profileModal').style.display = 'none';
      render();
    })();
  </script>
</body>
</html>
