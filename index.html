<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Player Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:Inter, sans-serif;
  background:#0f172a;
  color:white;
  margin:0;
  padding:20px;
}
h1{margin:0 0 20px}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:8px;
  text-align:center;
}
th{background:#1e293b}
tr:nth-child(even){background:#1e293b}
.leaderboard{
  display:flex;
  gap:20px;
  margin-bottom:20px;
}
.medal-card{
  flex:1;
  padding:20px;
  border-radius:10px;
  text-align:center;
  font-weight:700;
}
.gold{border:4px solid gold}
.silver{border:4px solid silver}
.bronze{border:4px solid #cd7f32}
.score{font-size:26px;margin-top:10px}

#profileModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
}
.modal-content{
  background:#1e293b;
  padding:20px;
  width:90%;
  max-width:900px;
  border-radius:12px;
}
.modal-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.modal-controls{
  margin:15px 0;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
select{
  padding:6px;
}
canvas{
  height:300px !important;
}
button{
  cursor:pointer;
}
</style>
</head>

<body>

<h1>Leaderboard</h1>

<div class="leaderboard" id="topThree"></div>

<table>
<thead>
<tr>
<th>Rank</th>
<th>Name</th>
<th>Power</th>
<th>Points</th>
<th>Total</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<!-- Overlay -->
<div id="profileModal">
<div class="modal-content">
<div class="modal-top">
<h2 id="modalName"></h2>
<button onclick="closeModal()">Close</button>
</div>

<div class="modal-controls">
<select id="weekSelectOverlay"></select>
<select id="metricSelect"></select>
</div>

<canvas id="playerChart"></canvas>

</div>
</div>

<script>
let chartInstance=null;
const CAP=2.5;

const fmt=(n)=>{
 const num=parseFloat(n)||0;
 return num.toLocaleString(undefined,{
   minimumFractionDigits:0,
   maximumFractionDigits:2
 });
};

const load=()=>JSON.parse(localStorage.getItem('formData')||'[]');

function render(){

 const data=load();
 const names=[...new Set(data.map(d=>d.name))];
 let results=[];

 names.forEach(name=>{
   const entries=data.filter(d=>d.name===name);
   const latest=entries[entries.length-1]||{};
   let total=0;

   entries.forEach(e=>{
     const p=parseFloat(e.power)||0;
     const pts=parseFloat(e.points)||0;
     if(p>0) total+=pts/p;
   });

   results.push({
     name,
     power:latest.power||0,
     points:latest.points||0,
     total
   });
 });

 results.sort((a,b)=>b.total-a.total);

 // Top 3 medals
 const medals=['gold','silver','bronze'];
 const medalEmoji=['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];

 topThree.innerHTML=results.slice(0,3).map((r,i)=>`
   <div class="medal-card ${medals[i]}">
     <div style="font-size:40px">${medalEmoji[i]}</div>
     <div>${r.name}</div>
     <div class="score">${fmt(r.total)}</div>
   </div>
 `).join('');

 // Table
 tableBody.innerHTML=results.map((r,i)=>`
   <tr onclick="openOverlay('${r.name}')">
   <td>${i+1}</td>
   <td>${r.name}</td>
   <td>${fmt(r.power)}</td>
   <td>${fmt(r.points)}</td>
   <td>${fmt(r.total)}</td>
   </tr>
 `).join('');
}

function openOverlay(name){

 const data=load().filter(d=>d.name===name);
 modalName.textContent=name;

 profileModal.style.display='flex';

 const weeks=['week 1','week 2','week 3','overall'];

 weekSelectOverlay.innerHTML=weeks.map(w=>`
   <option value="${w}">${w.toUpperCase()}</option>
 `).join('');

 weekSelectOverlay.onchange=()=>updateMetricOptions(name);
 metricSelect.onchange=()=>drawChart(name);

 updateMetricOptions(name);
}

function updateMetricOptions(name){

 const week=weekSelectOverlay.value;
 let options=[];

 if(week==='week 1'){
   options=['power','points','quests'];
 }
 if(week==='week 2'){
   options=['power','points','efficiency','quests','hunt'];
 }
 if(week==='week 3'){
   options=['power','points','efficiency','quests','throne','throne efficiency'];
 }
 if(week==='overall'){
   options=['power','points','efficiency','quests','throne','throne efficiency'];
 }

 metricSelect.innerHTML=options.map(o=>
   `<option value="${o}">${o.toUpperCase()}</option>`
 ).join('');

 drawChart(name);
}

function drawChart(name){

 const data=load().filter(d=>d.name===name);
 const week=weekSelectOverlay.value;
 const metric=metricSelect.value;

 let values=[];
 let labels=[];

 if(week==='overall'){

   const w1=data.find(d=>d.week==='week 1')||{};
   const w3=data.find(d=>d.week==='week 3')||{};
   const latest=data[data.length-1]||{};
   const power=parseFloat(latest.power)||0;

   if(metric==='power') values=[latest.power||0];
   if(metric==='points') values=[latest.points||0];
   if(metric==='quests') values=[latest.quest||0];
   if(metric==='efficiency'){
     const diff=(parseFloat(w3.points)||0)-(parseFloat(w1.points)||0);
     values=[power>0?diff/power:0];
   }
   if(metric==='throne') values=[latest.throne||0];
   if(metric==='throne efficiency'){
     values=[power>0?(latest.throne||0)/power:0];
   }

   labels=['Overall'];

 }else{

   const entry=data.find(d=>d.week===week)||{};
   const p=parseFloat(entry.power)||0;
   const pts=parseFloat(entry.points)||0;

   if(metric==='power') values=[p];
   if(metric==='points') values=[pts];
   if(metric==='quests') values=[entry.quest||0];
   if(metric==='hunt') values=[entry.hunt||0];
   if(metric==='throne') values=[entry.throne||0];
   if(metric==='efficiency') values=[p>0?pts/p:0];
   if(metric==='throne efficiency') values=[p>0?(entry.throne||0)/p:0];

   labels=[week.toUpperCase()];
 }

 const ctx=document.getElementById('playerChart').getContext('2d');
 if(chartInstance) chartInstance.destroy();

 chartInstance=new Chart(ctx,{
   type:'bar',
   data:{
     labels,
     datasets:[{
       label:metric.toUpperCase(),
       data:values
     }]
   },
   options:{maintainAspectRatio:false}
 });
}

function closeModal(){
 profileModal.style.display='none';
}

render();
</script>

</body>
</html>