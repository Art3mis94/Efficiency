<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Alliance Dashboard - Elite</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f1f5f9; --text: #1e293b; --accent: #3b82f6; --dark: #0f172a; --success: #10b981; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        
        /* Header & Big Stats */
        header { background: var(--dark); color: white; padding: 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--accent); }
        .stat-grid { display: flex; gap: 30px; }
        .stat-box { text-align: center; }
        .stat-box label { display: block; font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; }
        .stat-box span { font-size: 2rem; font-weight: 900; color: white; }

        nav { display: flex; justify-content: center; gap: 15px; padding: 1rem; background: #cbd5e1; border-bottom: 1px solid #94a3b8; }
        nav a { text-decoration: none; color: white; background: var(--accent); padding: 0.6rem 1.5rem; border-radius: 10px; font-weight: 800; font-size: 0.9rem; transition: 0.2s; }
        nav a:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }

        .container { padding: 2rem; max-width: 1600px; margin: 0 auto; }
        
        /* Config & Controls */
        .controls { display: grid; grid-template-columns: 1fr auto; gap: 20px; margin-bottom: 2rem; background: white; padding: 1.5rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .mult-inputs { display: flex; gap: 10px; align-items: center; }
        .mult-inputs div { display: flex; align-items: center; gap: 5px; background: #f8fafc; padding: 5px 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .mult-inputs label { font-size: 0.6rem; font-weight: 800; color: #64748b; }
        .mult-inputs input { width: 60px; border: none; background: transparent; font-weight: 700; color: var(--accent); outline: none; }

        /* Table Styling */
        .table-wrap { background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 0.7rem; text-transform: uppercase; font-weight: 800; color: #64748b; border-bottom: 2px solid #e2e8f0; cursor: pointer; }
        td { padding: 14px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.9rem; font-weight: 500; }
        
        .dot { height: 11px; width: 11px; border-radius: 50%; display: inline-block; margin-right: 10px; background: #cbd5e1; }
        .dot.active { background: var(--success); box-shadow: 0 0 10px var(--success); }
        
        .rank-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 900; color: white; margin-left: 8px; text-transform: uppercase; }
        .top-1 { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .top-2 { background: linear-gradient(135deg, #94a3b8, #475569); }
        .top-3 { background: linear-gradient(135deg, #b45309, #78350f); }

        .edit-btn { background: #f1f5f9; color: var(--accent); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 800; font-size: 0.75rem; }
    </style>
</head>
<body>

<header>
    <div>
        <h1 style="margin:0; font-size: 1.5rem; letter-spacing: -1px;">ALLIANCE <span style="color:var(--accent)">DASHBOARD</span></h1>
    </div>
    <div class="stat-grid">
        <div class="stat-box"><label>Total Roster</label><span id="count_players">0</span></div>
        <div class="stat-box"><label>Leader</label><span id="top_player" style="color: #fbbf24;">---</span></div>
    </div>
</header>

<nav>
    <a href="index.html">DASHBOARD</a>
    <a href="trends.html">TRENDS</a>
    <a href="form.html">MANAGE DATA</a>
</nav>

<div class="container">
    <div class="controls">
        <div class="mult-inputs">
            <div><label>W1 Multi:</label><input id="M_W1" type="number" value="0.2" step="0.1" oninput="render()"></div>
            <div><label>Hunt:</label><input id="M_HUNT" type="number" value="0.005" step="0.001" oninput="render()"></div>
            <div><label>Quest:</label><input id="M_QUEST" type="number" value="0.05" step="0.01" oninput="render()"></div>
            <div><label>Throne:</label><input id="M_THRONE" type="number" value="1000000000" oninput="render()"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="dashSearch" placeholder="Search Member..." oninput="render()" style="width:200px; padding:10px; border-radius:10px; border:1px solid #cbd5e1;">
            <select id="weekSelect" onchange="render()" style="padding:10px; border-radius:10px; font-weight:800; border:1px solid #cbd5e1; background: white;">
                <option value="week 1">Week 1</option>
                <option value="week 2">Week 2</option>
                <option value="week 3" selected>Week 3</option>
                <option value="overall">Overall</option>
            </select>
        </div>
    </div>

    <div class="table-wrap">
        <table id="dashTable">
            <thead>
                <tr>
                    <th onclick="setSort('name')">Member Name</th>
                    <th onclick="setSort('p')">Power</th>
                    <th onclick="setSort('pts')">Points</th>
                    <th onclick="setSort('eff')">Efficiency</th>
                    <th onclick="setSort('w1S')">W1 Score</th>
                    <th onclick="setSort('act')">Act.</th>
                    <th onclick="setSort('part')">Part.</th>
                    <th onclick="setSort('quest')">Quest</th>
                    <th onclick="setSort('throne')">Throne</th>
                    <th onclick="setSort('picks')">Picks</th>
                    <th onclick="setSort('total')">Total Score â–²</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="dashBody"></tbody>
        </table>
    </div>
</div>

<script>
let sortCol = 'total', sortAsc = false;

const load = () => JSON.parse(localStorage.getItem('formData') || '[]');

window.setSort = (col) => {
    if(sortCol === col) sortAsc = !sortAsc;
    else { sortCol = col; sortAsc = false; }
    render();
};

window.goToEdit = (name) => {
    localStorage.setItem('editTargetName', name);
    localStorage.setItem('editTargetWeek', document.getElementById('weekSelect').value);
    window.location.href = 'form.html';
};

window.render = () => {
    const data = load();
    const view = document.getElementById('weekSelect').value;
    const search = document.getElementById('dashSearch').value.toLowerCase();
    
    // Multipliers from UI
    const MW = parseFloat(document.getElementById('M_W1').value) || 0;
    const MH = parseFloat(document.getElementById('M_HUNT').value) || 0;
    const MQ = parseFloat(document.getElementById('M_QUEST').value) || 0;
    const MT = parseFloat(document.getElementById('M_THRONE').value) || 0;

    const names = [...new Set(data.map(d => d.name))];
    let results = [];

    names.forEach(name => {
        const eAll = data.filter(d => d.name === name);
        const w1 = eAll.find(x => x.week === 'week 1') || { points:0, power:1 };
        const w2 = eAll.find(x => x.week === 'week 2');
        const w3 = eAll.find(x => x.week === 'week 3');

        // Logic: Pick active entry based on selection
        let active = w1;
        if(view === 'week 2') active = w2 || w1;
        if(view === 'week 3' || view === 'overall') active = w3 || w2 || w1;

        const p = parseFloat(active.power) || 1;
        const pts = parseFloat(active.points) || 0;

        // FIXED EFFICIENCY LOGIC: No NaN, No Negatives
        let effScore = 0;
        if (view === 'overall') {
            // Overall = (Week 3 - Week 1) / Power
            const w3Pts = w3 ? parseFloat(w3.points) : pts;
            const w1Pts = w1 ? parseFloat(w1.points) : 0;
            effScore = (w3Pts - w1Pts) / (p/1000000);
        } else {
            // Weekly = Current Points / Power
            effScore = pts / (p/1000000);
        }
        if (isNaN(effScore) || effScore < 0) effScore = 0;

        let w1Score = (parseFloat(w1.points) || 0) * MW;
        let questScore = (parseFloat(active.quest) || 0) * MQ;
        let huntScore = (parseFloat(active.hunt) || 0) * MH;
        let throneScore = (p > 1) ? ((parseFloat(active.throne) || 0) / p) * MT : 0;

        // Activity & Participation (Summed correctly)
        let act = 0, part = 0;
        const period = (view === 'overall' || view === 'week 3') ? [w1, w2, w3] : (view === 'week 2' ? [w1, w2] : [w1]);
        period.filter(x => x).forEach(e => {
            act += ((e.lava?1:0) + (e.challenge?1:0) + (e.donations?1:0)) * 0.833;
            part += Math.min(2.5, ((e.esb?1:0)*(0.833)) + ((e.dv?1:0)*(0.833)) + ((e.mon?1:0)*(0.416)) + ((e.wed?1:0)*(0.416)));
        });

        // Summed Picks + Global Green Light
        let totalPicks = 0, has100 = false;
        eAll.forEach(we => {
            totalPicks += (we.p100?100:0) + (we.p40?40:0) + (we.p20?20:0) + (we.p5?5:0);
            if(we.p100 == 1) has100 = true;
        });

        const total = w1Score + effScore + act + part + huntScore + questScore + throneScore;

        results.push({
            name, p, pts, w1S: w1Score, eff: effScore, act, part, 
            quest: questScore, throne: throneScore, picks: totalPicks, total, has100
        });
    });

    results = results.filter(r => r.name.toLowerCase().includes(search));
    
    // Sorting
    results.sort((a, b) => {
        let vA = a[sortCol], vB = b[sortCol];
        return sortAsc ? (vA > vB ? 1 : -1) : (vB > vA ? 1 : -1);
    });

    // Update Big Stats
    document.getElementById('count_players').innerText = results.length;
    document.getElementById('top_player').innerText = results[0] ? results[0].name : "---";

    document.getElementById('dashBody').innerHTML = results.map((r, i) => {
        let badge = "";
        if(i === 0) badge = `<span class="rank-badge top-1">KING</span>`;
        else if(i === 1) badge = `<span class="rank-badge top-2">#2</span>`;
        else if(i === 2) badge = `<span class="rank-badge top-3">#3</span>`;

        return `<tr>
            <td><span class="dot ${r.has100?'active':''}"></span><strong>${r.name}</strong>${badge}</td>
            <td>${(r.p/1000000000).toFixed(2)}B</td>
            <td>${r.pts.toLocaleString()}</td>
            <td>${r.eff.toFixed(2)}</td>
            <td>${r.w1S.toLocaleString()}</td>
            <td>${r.act.toFixed(1)}</td>
            <td>${r.part.toFixed(1)}</td>
            <td>${r.quest.toLocaleString()}</td>
            <td>${r.throne.toFixed(1)}</td>
            <td>${r.picks}</td>
            <td style="font-weight:900; color:var(--accent)">${r.total.toFixed(2)}</td>
            <td><button class="edit-btn" onclick="goToEdit('${r.name}')">EDIT</button></td>
        </tr>`;
    }).join('');
};

render();
</script>
</body>
</html>
