<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Alliance Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f8fafc; --text: #0f172a; --accent: #3b82f6; --dark: #1e293b; --success: #10b981; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }
        header { background: var(--dark); color: white; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        nav { display: flex; justify-content: center; gap: 10px; padding: 1rem; background: #e2e8f0; }
        nav a { text-decoration: none; color: white; background: var(--accent); padding: 0.5rem 1rem; border-radius: 8px; font-weight: 700; font-size: 0.85rem; }
        
        .container { padding: 2rem; }
        .controls { display: flex; gap: 15px; margin-bottom: 2rem; align-items: center; background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        select, input { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: inherit; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 0.75rem; text-transform: uppercase; cursor: pointer; user-select: none; }
        th:hover { background: #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
        tr:hover { background: #f8fafc; }

        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; background: #cbd5e1; }
        .dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .rank-tag { padding: 4px 8px; border-radius: 6px; font-weight: 800; font-size: 0.7rem; color: white; }
        .top1 { background: #fbbf24; } .top2 { background: #94a3b8; } .top3 { background: #b45309; }
        
        .edit-btn { background: #f1f5f9; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.7rem; color: var(--accent); }
    </style>
</head>
<body>

<header>
    <h1>Alliance Dashboard</h1>
    <div id="statsCount">0 Members</div>
</header>

<nav>
    <a href="index.html">Dashboard</a>
    <a href="trends.html">Trends</a>
    <a href="form.html">Manage Data</a>
</nav>

<div class="container">
    <div class="controls">
        <select id="weekSelect" onchange="render()">
            <option value="week 1">Week 1 Only</option>
            <option value="week 2">Week 2 (+W1)</option>
            <option value="week 3" selected>Week 3 (+W1, W2)</option>
            <option value="overall">Full Cycle (Overall)</option>
        </select>
        <input type="text" id="dashSearch" placeholder="Filter roster..." oninput="render()">
    </div>

    <table id="dashTable">
        <thead>
            <tr>
                <th onclick="setSort('name')">Player</th>
                <th onclick="setSort('p')">Power</th>
                <th onclick="setSort('pts')">Points</th>
                <th onclick="setSort('eff')">Efficiency</th>
                <th onclick="setSort('w1S')">W1 Multi</th>
                <th onclick="setSort('act')">Act.</th>
                <th onclick="setSort('part')">Part.</th>
                <th onclick="setSort('quest')">Quest</th>
                <th onclick="setSort('throne')">Throne</th>
                <th onclick="setSort('picks')">Picks</th>
                <th onclick="setSort('total')">Total â–²</th>
                <th>Edit</th>
            </tr>
        </thead>
        <tbody id="dashBody"></tbody>
    </table>
</div>

<script>
let sortCol = 'total', sortAsc = false;

// Multipliers
const M = { W1: 0.2, HUNT: 0.005, QUEST: 0.05, THRONE: 1000000000 };

const load = () => JSON.parse(localStorage.getItem('formData') || '[]');

window.setSort = (col) => {
    if(sortCol === col) sortAsc = !sortAsc;
    else { sortCol = col; sortAsc = false; }
    render();
};

window.goToEdit = (name) => {
    localStorage.setItem('editTargetName', name);
    localStorage.setItem('editTargetWeek', document.getElementById('weekSelect').value);
    window.location.href = 'form.html';
};

window.render = () => {
    const data = load();
    const view = document.getElementById('weekSelect').value;
    const search = document.getElementById('dashSearch').value.toLowerCase();
    const names = [...new Set(data.map(d => d.name))];
    let results = [];

    names.forEach(name => {
        const eAll = data.filter(d => d.name === name);
        const w1 = eAll.find(x => x.week === 'week 1');
        const w2 = eAll.find(x => x.week === 'week 2');
        const w3 = eAll.find(x => x.week === 'week 3');
        const home = eAll.find(x => x.week === 'home week');

        // Determine Active Entry
        let activeEntry = w1;
        if(view === 'week 2') activeEntry = w2 || w1;
        if(view === 'week 3' || view === 'overall') activeEntry = w3 || w2 || w1;
        if(!activeEntry) return;

        const p = parseFloat(activeEntry.power) || 1;
        const pts = parseFloat(activeEntry.points) || 0;

        // Calculations
        let w1Score = w1 ? (parseFloat(w1.points) * M.W1) : 0;
        let effScore = (view !== 'week 1' && w1) ? ((pts - parseFloat(w1.points)) / (p/1000000)) : 0;
        let questScore = (parseFloat(activeEntry.quest || 0) * M.QUEST);
        let huntScore = (parseFloat(activeEntry.hunt || 0) * M.HUNT);
        let throneScore = (parseFloat(activeEntry.throne || 0) / p) * M.THRONE;

        // Activity & Participation
        let act = 0, part = 0;
        const period = (view === 'overall' || view === 'week 3') ? [w1, w2, w3] : (view === 'week 2' ? [w1, w2] : [w1]);
        period.filter(x => x).forEach(e => {
            act += ((e.lava?1:0) + (e.challenge?1:0) + (e.donations?1:0)) * 0.833;
            part += Math.min(2.5, ((e.esb?1:0)*(0.833)) + ((e.dv?1:0)*(0.833)) + ((e.mon?1:0)*(0.416)) + ((e.wed?1:0)*(0.416)));
        });

        // FIXED: Global Green Light & Summed Picks
        let totalPicks = 0;
        let has100 = false;
        eAll.forEach(we => {
            totalPicks += (we.p100?100:0) + (we.p40?40:0) + (we.p20?20:0) + (we.p5?5:0);
            if(we.p100 == 1) has100 = true;
        });

        const total = w1Score + effScore + act + part + huntScore + questScore + throneScore;

        results.push({
            name, p, pts, w1S: w1Score, eff: effScore, act, part, 
            quest: questScore, throne: throneScore, picks: totalPicks, total, has100
        });
    });

    // Apply Search Filter
    results = results.filter(r => r.name.toLowerCase().includes(search));

    // Numeric Sorting Logic
    results.sort((a, b) => {
        let vA = a[sortCol], vB = b[sortCol];
        if (typeof vA === 'string') return sortAsc ? vA.localeCompare(vB) : vB.localeCompare(vA);
        return sortAsc ? vA - vB : vB - vA;
    });

    document.getElementById('statsCount').innerText = results.length + " Members";
    
    document.getElementById('dashBody').innerHTML = results.map((r, i) => {
        const rankClass = (i === 0) ? 'top1' : (i === 1) ? 'top2' : (i === 2) ? 'top3' : '';
        const rankTag = i < 3 ? `<span class="rank-tag ${rankClass}">#${i+1}</span>` : '';
        
        return `<tr>
            <td><span class="dot ${r.has100?'active':''}"></span>${r.name} ${rankTag}</td>
            <td>${(r.p/1000000000).toFixed(2)}B</td>
            <td>${r.pts.toLocaleString()}</td>
            <td>${r.eff.toFixed(2)}</td>
            <td>${r.w1S.toLocaleString()}</td>
            <td>${r.act.toFixed(1)}</td>
            <td>${r.part.toFixed(1)}</td>
            <td>${r.quest.toLocaleString()}</td>
            <td>${r.throne.toFixed(1)}</td>
            <td>${r.picks}</td>
            <td style="font-weight:800; color:var(--accent)">${r.total.toFixed(2)}</td>
            <td><button class="edit-btn" onclick="goToEdit('${r.name}')">Edit</button></td>
        </tr>`;
    }).join('');
};

render();
</script>
</body>
</html>
