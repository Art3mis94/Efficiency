<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alliance Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f8fafc; --text: #1e293b; --accent: #3b82f6; --success: #10b981;
            --dark: #1e40af; --muted: #64748b; --gold: #f59e0b; --silver: #94a3b8; --bronze: #d97706;
        }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); font-size: .85rem; }
        header { background: var(--dark); color: #fff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        nav { display: flex; justify-content: center; gap: 10px; padding: .75rem; background: #e2e8f0; }
        nav a { color: #fff; text-decoration: none; padding: .5rem 1rem; background: var(--accent); border-radius: 6px; font-weight: 700; }
        .container { padding: 1.5rem; max-width: 1400px; margin: auto; }
        
        .top-row { display: grid; grid-template-columns: 1fr 3fr; gap: 20px; margin-bottom: 30px; align-items: flex-end; }
        .card { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,.05); text-align: center; height: fit-content; }
        .card label { font-size: .7rem; color: var(--muted); font-weight: 800; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .card span { font-size: 2.5rem; font-weight: 800; color: var(--accent); }
        
        .top-three { display: flex; justify-content: center; gap: 15px; align-items: flex-end; height: 160px; }
        .leader-card { flex: 1; text-align: center; padding: 15px; border-radius: 18px; background: white; box-shadow: 0 10px 15px rgba(0,0,0,.05); font-weight: 800; border: 2px solid #e2e8f0; max-width: 200px; }
        .leader-card h2 { margin: 5px 0; font-size: 1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .leader-card .score { font-size: 1.3rem; color: var(--accent); }
        .rank-1 { border-color: var(--gold); height: 100%; transform: scale(1.05); z-index: 2; box-shadow: 0 15px 25px rgba(245, 158, 11, 0.2); }
        .rank-2 { border-color: var(--silver); height: 85%; }
        .rank-3 { border-color: var(--bronze); height: 75%; }

        details { background: white; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        summary { padding: 12px; cursor: pointer; font-weight: 800; color: var(--muted); }
        .config-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 15px; }
        .config-grid input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; }
        
        .table-wrap { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,.1); }
        table { width: 100%; border-collapse: collapse; min-width: 1100px; }
        th { background: #f8fafc; padding: 15px 12px; font-size: .65rem; text-transform:uppercase; color: var(--muted); border-bottom: 2px solid #e2e8f0; text-align: left; cursor: pointer; user-select: none; }
        th:hover { background: #f1f5f9; color: var(--accent); }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
        .status-green { color: var(--success) !important; font-weight: 800; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; width: 95%; max-width: 1100px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
        .ov-table { width: 100%; border-collapse: collapse; margin-top: 20px; text-align: center; font-size: 0.8rem; }
        .ov-table th, .ov-table td { border: 1px solid #e2e8f0; padding: 10px; }
        .btn-edit { padding: 6px 12px; background: var(--success); color: white; border: none; border-radius: 6px; font-weight: 700; cursor: pointer; font-size: .7rem; }
        .sort-indicator { font-size: 0.6rem; margin-left: 4px; }
    </style>
</head>
<body>

<header><h1>Alliance Dashboard</h1></header>
<nav>
    <a href="index.html">Dashboard</a>
    <a href="trends.html">Trends</a>
    <a href="form.html">Manage Data</a>
</nav>

<div class="container">
    <div class="top-row">
        <div class="card"><label>Roster Count</label><span id="stat_total">0</span></div>
        <div class="top-three" id="topThreeList"></div>
    </div>

    <details>
        <summary>‚öôÔ∏è SCORING CONFIGURATION</summary>
        <div class="config-grid">
            <div><label>M_THRONE</label><input type="number" step="0.1" id="m_throne"></div>
            <div><label>M_QUEST</label><input type="number" step="0.0000001" id="m_quest"></div>
            <div><label>M_W1_BASE</label><input type="number" step="0.1" id="m_w1"></div>
            <div><label>M_HUNT</label><input type="number" step="0.0000001" id="m_hunt"></div>
        </div>
    </details>

    <div style="display:flex; gap:15px; margin-bottom:15px;">
        <select id="weekSelect" style="padding: 10px; border-radius: 8px; font-weight: 800; border: 2px solid var(--accent);">
            <option value="overall">OVERALL</option>
            <option value="week 1">WEEK 1</option>
            <option value="week 2">WEEK 2</option>
            <option value="week 3">WEEK 3</option>
        </select>
        <input type="text" id="dashSearch" placeholder="Search members..." style="flex:1; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1;">
    </div>

    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th style="cursor:default">Rank</th>
                    <th onclick="setSort('name')">Name<span id="sort_name" class="sort-indicator"></span></th>
                    <th onclick="setSort('p')">Power<span id="sort_p" class="sort-indicator"></span></th>
                    <th onclick="setSort('pts')">Points<span id="sort_pts" class="sort-indicator"></span></th>
                    <th onclick="setSort('w1S')">W1 Multi<span id="sort_w1S" class="sort-indicator"></span></th>
                    <th onclick="setSort('eff')">Efficiency<span id="sort_eff" class="sort-indicator"></span></th>
                    <th onclick="setSort('act')">Act<span id="sort_act" class="sort-indicator"></span></th>
                    <th onclick="setSort('part')">Part<span id="sort_part" class="sort-indicator"></span></th>
                    <th onclick="setSort('hunt')">Hunt<span id="sort_hunt" class="sort-indicator"></span></th>
                    <th onclick="setSort('quest')">Quest<span id="sort_quest" class="sort-indicator"></span></th>
                    <th onclick="setSort('throne')">Throne<span id="sort_throne" class="sort-indicator"></span></th>
                    <th onclick="setSort('total')">Total<span id="sort_total" class="sort-indicator"></span></th>
                    <th onclick="setSort('picks')">Picks<span id="sort_picks" class="sort-indicator"></span></th>
                    <th style="cursor:default">Action</th>
                </tr>
            </thead>
            <tbody id="dashTableBody"></tbody>
        </table>
    </div>
</div>

<div id="profileModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="modalName"></h2>
            <div>
                <select id="chartMetricSelect" style="padding:8px; border-radius:6px; font-weight:bold;"></select>
                <button onclick="closeModal()" style="font-size:24px; border:none; background:none; cursor:pointer; margin-left:15px;">‚úï</button>
            </div>
        </div>
        <div style="height:350px; margin-bottom:20px;"><canvas id="playerChart"></canvas></div>
        <table class="ov-table">
            <thead>
                <tr><th>Week</th><th>Power</th><th>Points</th><th>Quest</th><th>Efficiency</th><th>Throne</th></tr>
            </thead>
            <tbody id="ovTableBody"></tbody>
        </table>
    </div>
</div>

<script>
(function(){
    let chartInstance = null;
    let currentOverlayData = [];
    let sortCol = 'total';
    let sortAsc = false;

    const load = () => JSON.parse(localStorage.getItem('formData') || '[]');
    const getMults = () => JSON.parse(localStorage.getItem('scoringMultipliers') || '{"M_THRONE":3.0,"M_QUEST":0.0000025,"M_W1":0.1,"M_HUNT":0.00001}');
    const fmt = n => parseFloat(n || 0).toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
    const fmtPower = n => n ? (parseFloat(n)/1000).toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1})+"Bn" : "0.0Bn";

    const mConfig = getMults();
    document.getElementById('m_throne').value = mConfig.M_THRONE;
    document.getElementById('m_quest').value = mConfig.M_QUEST;
    document.getElementById('m_w1').value = mConfig.M_W1;
    document.getElementById('m_hunt').value = mConfig.M_HUNT;

    ['m_throne','m_quest','m_w1','m_hunt'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            const val = {
                M_THRONE: parseFloat(document.getElementById('m_throne').value),
                M_QUEST: parseFloat(document.getElementById('m_quest').value),
                M_W1: parseFloat(document.getElementById('m_w1').value),
                M_HUNT: parseFloat(document.getElementById('m_hunt').value)
            };
            localStorage.setItem('scoringMultipliers', JSON.stringify(val));
            render();
        });
    });

    window.setSort = (col) => {
        if (sortCol === col) sortAsc = !sortAsc;
        else { sortCol = col; sortAsc = false; }
        render();
    };

    window.render = () => {
        const data = load();
        const mults = getMults();
        const view = document.getElementById('weekSelect').value;
        const search = document.getElementById('dashSearch').value.toLowerCase();
        const names = [...new Set(data.map(d => d.name))];
        let results = [];

        names.forEach(name => {
            const eAll = data.filter(d => d.name === name);
            const home = eAll.find(x => x.week === 'home week');
            const w1 = eAll.find(x => x.week === 'week 1');
            const w2 = eAll.find(x => x.week === 'week 2');
            const w3 = eAll.find(x => x.week === 'week 3');

            const activeEntry = (view === 'overall' || view === 'week 3') ? (w3 || w2 || w1) : (view === 'week 2' ? (w2 || w1) : w1);
            if (!activeEntry) return;

            const pCurr = parseFloat(activeEntry.power) || 1;
            let w1Score = w1 ? (parseFloat(w1.points) * mults.M_W1) : 0;
            let effScore = (view !== 'week 1' && w1) ? ((parseFloat(activeEntry.points) - parseFloat(w1.points)) / pCurr) : 0;
            let questScore = (parseFloat(activeEntry.quest || 0) * mults.M_QUEST);
            let throneScore = (parseFloat(activeEntry.throne || 0) / pCurr) * mults.M_THRONE;
            let huntScore = (parseFloat(activeEntry.hunt || 0) * mults.M_HUNT);

            let actScore = 0, partScore = 0;
            const periodData = (view === 'overall' || view === 'week 3') ? [w1, w2, w3] : (view === 'week 2' ? [w1, w2] : [w1]);
            
            periodData.filter(x => x).forEach(e => {
                actScore += ((e.lava?1:0) + (e.challenge?1:0) + (e.donations?1:0)) * 0.833;
                partScore += Math.min(2.5, ((e.esb?1:0)*(2.5/3)) + ((e.dv?1:0)*(2.5/3)) + ((e.mon?1:0)*(2.5/6)) + ((e.wed?1:0)*(2.5/6)));
            });

            // Hero picks forced from HOME WEEK
            let picks = 0, has100 = false;
            if (home) {
                picks = (home.p100?100:0) + (home.p40?40:0) + (home.p20?20:0) + (home.p5?5:0);
                if(home.p100 == 1) has100 = true;
            }

            const total = w1Score + effScore + actScore + partScore + huntScore + questScore + throneScore;

            results.push({
                name, p: pCurr, pts: parseFloat(activeEntry.points)||0, w1S: w1Score, eff: effScore, 
                act: actScore, part: partScore, hunt: huntScore, quest: questScore, 
                throne: throneScore, total, picks, has100, targetWeek: activeEntry.week
            });
        });

        // 1. Calculate Global Rankings (Always by Total score)
        const rankedResults = [...results].sort((a,b) => b.total - a.total);
        
        // 2. Apply Custom Sorting for the table view
        results.sort((a, b) => {
            let valA = a[sortCol], valB = b[sortCol];
            if (typeof valA === 'string') return sortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return sortAsc ? valA - valB : valB - valA;
        });

        // 3. Update UI Sorting Indicators
        document.querySelectorAll('.sort-indicator').forEach(s => s.textContent = '');
        const indicatorId = 'sort_' + sortCol;
        if(document.getElementById(indicatorId)) document.getElementById(indicatorId).textContent = sortAsc ? ' ‚ñ≤' : ' ‚ñº';

        document.getElementById('stat_total').textContent = results.length;

        // Podium (Always based on top 3 total scores)
        const meds = ["ü•á", "ü•à", "ü•â"];
        const top3 = rankedResults.slice(0,3);
        const podiumArr = [top3[1], top3[0], top3[2]].filter(x => x); 

        document.getElementById('topThreeList').innerHTML = podiumArr.map((r) => {
            const actualRank = rankedResults.indexOf(r) + 1; 
            return `<div class="leader-card rank-${actualRank}">
                <div style="font-size:1.2rem">${meds[actualRank-1]}</div>
                <h2>${r.name}</h2>
                <div class="score">${fmt(r.total)}</div>
            </div>`;
        }).join('');

        // Table Render
        document.getElementById('dashTableBody').innerHTML = results.filter(r => r.name.toLowerCase().includes(search)).map((r) => {
            const globalRank = rankedResults.findIndex(x => x.name === r.name) + 1;
            return `
            <tr onclick="openOverlay('${r.name.replace(/'/g,"\\'")}')">
                <td>#${globalRank}</td>
                <td class="${r.has100?'status-green':''}"><strong>${r.name}</strong></td>
                <td>${fmtPower(r.p)}</td><td>${fmt(r.pts)}</td>
                <td>${fmt(r.w1S)}</td><td>${fmt(r.eff)}</td>
                <td>${fmt(r.act)}</td><td>${fmt(r.part)}</td>
                <td>${fmt(r.hunt)}</td><td>${fmt(r.quest)}</td><td>${fmt(r.throne)}</td>
                <td style="font-weight:800">${fmt(r.total)}</td>
                <td>${r.picks}</td>
                <td><button class="btn-edit" onclick="event.stopPropagation(); editMember('${r.name.replace(/'/g,"\\'")}', '${r.targetWeek}')">Edit</button></td>
            </tr>`}).join('');
    };

    window.openOverlay = (name) => {
        const data = load();
        const entries = ['week 1', 'week 2', 'week 3'].map(w => data.find(d => d.name === name && d.week === w) || { week: w });
        const w1 = entries[0];
        currentOverlayData = entries.map(e => {
            let eff = 0;
            if (e.points && w1.points && e.power && e.week !== 'week 1') eff = (parseFloat(e.points) - parseFloat(w1.points)) / parseFloat(e.power);
            return { ...e, efficiency: eff };
        });
        document.getElementById('modalName').textContent = name;
        document.getElementById('ovTableBody').innerHTML = currentOverlayData.map(e => `
            <tr><td>${e.week.toUpperCase()}</td><td>${fmtPower(e.power)}</td><td>${fmt(e.points)}</td><td>${fmt(e.quest)}</td><td>${fmt(e.efficiency)}</td><td>${fmt(e.throne)}</td></tr>`).join('');
        const sel = document.getElementById('chartMetricSelect');
        sel.innerHTML = `<option value="power">Power</option><option value="points">Points</option><option value="efficiency">Efficiency</option><option value="quest">Quests</option>`;
        sel.onchange = updateChartData;
        document.getElementById('profileModal').style.display = 'flex';
        updateChartData();
    };

    window.updateChartData = () => {
        const metric = document.getElementById('chartMetricSelect').value;
        const vals = currentOverlayData.map(e => parseFloat(e[metric]) || 0);
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(document.getElementById('playerChart'), {
            type:'line', 
            data:{ labels:['W1','W2','W3'], datasets:[{ label: metric.toUpperCase(), data: vals, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3, pointRadius: 5 }]},
            options:{ maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { callback: v => (metric === 'power') ? (v/1000).toFixed(1) + 'Bn' : v.toLocaleString() } } }}
        });
    };

    window.editMember = (name, week) => {
        localStorage.setItem('editTargetName', name);
        localStorage.setItem('editTargetWeek', week);
        window.location.href = 'form.html';
    };

    document.getElementById('weekSelect').addEventListener('change', render);
    document.getElementById('dashSearch').addEventListener('input', render);
    window.closeModal = () => document.getElementById('profileModal').style.display = 'none';
    render();
})();
</script>
</body>
</html>
